<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #fefefe;
      color: #111;
      margin: 0;
      padding: 0;
      transition: 0.3s;
    }
    header {
      text-align: center;
      background: #00b894;
      color: white;
      padding: 1rem;
      font-size: 1.6rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .container { max-width: 900px; margin: auto; padding: 1rem; }
    button {
      background: #00b894;
      color: white;
      border: none;
      border-radius: 8px;
      padding: .6rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      margin: .3rem;
      transition: 0.2s;
    }
    button:hover { background: #009d82; }
    .exercise {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      animation: fadeIn 0.3s ease;
    }
    .exercise h3 { margin: .2rem 0; }
    .exercise small { display: block; color: #555; margin-bottom: .3rem; }
    input {
      width: 70px;
      padding: .3rem;
      margin: .2rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }
    .series-list div {
      background: #eafaf4;
      margin: .2rem 0;
      padding: .3rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-serie {
      background: none;
      color: #e74c3c;
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
    }
    #timerSticky {
      position: fixed;
      bottom: 20%;
      left: 10px;
      background: #00b894;
      color: white;
      padding: .7rem 1rem;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
    .hidden { display: none; }
    @keyframes fadeIn {
      from {opacity:0; transform:translateY(10px);}
      to {opacity:1; transform:translateY(0);}
    }
  </style>
</head>
<body>
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="startSession('A')">‚ñ∂ Giorno A</button>
    <button onclick="startSession('B')">‚ñ∂ Giorno B</button>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showHistory()">üìú Storico</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <div id="timerSticky"></div>

  <script type="module">
    // üîë CONFIG SUPABASE
    const SUPABASE_URL = "https://oyzouvusoysuhylijfdm.supabase.co";
    const SUPABASE_KEY = "sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentSession = null;
    let timerInterval = null;

    // üìã Schede Giorno A/B
    const schede = {
      A: [
        { nome:"Chest Press", muscolo:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
        { nome:"Shoulder Press", muscolo:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
        { nome:"Pectoral Machine", muscolo:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
        { nome:"Alzate Laterali", muscolo:"Spalle", come:"Braccia piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
        { nome:"Crunch", muscolo:"Addome", come:"Contrai l‚Äôaddome.", att:"Non tirare il collo." }
      ],
      B: [
        { nome:"Lat Machine", muscolo:"Dorso", come:"Tira la barra al petto mantenendo il busto fermo.", att:"Non oscillare con la schiena." },
        { nome:"Rematore Macchina", muscolo:"Dorso", come:"Tira i manici verso l‚Äôaddome.", att:"Non inarcare la schiena." },
        { nome:"Leg Press", muscolo:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
        { nome:"Leg Curl", muscolo:"Femorali", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
        { nome:"Plank", muscolo:"Addome", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
      ]
    };

    // üöÄ Avvia sessione
    async function startSession(day) {
      document.getElementById("menu").classList.add("hidden");
      const { data } = await supa.from("sessions")
        .select("*")
        .eq("day", day)
        .gte("date", new Date(Date.now()-24*60*60*1000).toISOString());

      if (data && data.length) {
        currentSession = data[0];
      } else {
        const { data: created } = await supa.from("sessions").insert([{ day }]).select().single();
        currentSession = created;
      }

      const { data: existing } = await supa.from("exercises").select("*").eq("session_id", currentSession.id);
      if (!existing.length) {
        for (const ex of schede[day]) {
          await supa.from("exercises").insert([{
            session_id: currentSession.id,
            name: ex.nome,
            muscolo: ex.muscolo,
            series: JSON.stringify([])
          }]);
        }
      }

      loadSessionUI(day);
    }
    window.startSession = startSession;

    async function loadSessionUI(day) {
      const c = document.getElementById("session");
      c.innerHTML = `<h2>Sessione Giorno ${day}</h2>`;
      const { data: exs } = await supa.from("exercises").select("*").eq("session_id", currentSession.id);

      for (const ex of exs) {
        const serie = ex.series ? JSON.parse(ex.series) : [];
        const base = schede[day].find(s => s.nome === ex.name) || {};
        c.innerHTML += `
          <div class="exercise" data-name="${ex.name}">
            <h3>${ex.name || "Senza nome"}</h3>
            <small><b>${ex.muscolo || base.muscolo || "Muscolo non definito"}</b></small>
            <small>üëâ ${base.come || ""}</small>
            <small>‚ö†Ô∏è ${base.att || ""}</small>
            Rip: <input type="number" class="rip" min="1">
            Peso: <input type="number" class="peso" min="0">
            <button onclick="addSerie(this)">‚ûï Serie</button>
            <button onclick="startTimer(this,60)">‚è±Ô∏è Recupero</button>
            <div class="series-list">
              ${serie.map(s=>`<div>${s.rip}x${s.peso}kg <button class="delete-serie" onclick="deleteSerie(this)">üóë</button></div>`).join("")}
            </div>
          </div>`;
      }
      c.innerHTML += `<button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>`;
      c.classList.remove("hidden");
    }

    async function addSerie(btn){
      const exDiv = btn.closest(".exercise");
      const rip = exDiv.querySelector(".rip").value;
      const peso = exDiv.querySelector(".peso").value;
      if(!rip || !peso) return alert("Inserisci valori validi");
      const div = document.createElement("div");
      div.innerHTML = `${rip}x${peso}kg <button class="delete-serie" onclick="deleteSerie(this)">üóë</button>`;
      exDiv.querySelector(".series-list").appendChild(div);
      await saveSeries(exDiv.dataset.name);
    }

    async function deleteSerie(btn){
      const exDiv = btn.closest(".exercise");
      btn.parentElement.remove();
      await saveSeries(exDiv.dataset.name);
    }

    async function saveSeries(name){
      const exDiv = document.querySelector(`.exercise[data-name="${name}"]`);
      const series = Array.from(exDiv.querySelectorAll(".series-list div")).map(d=>{
        const match = d.textContent.match(/(\d+)x(\d+)/);
        return { rip: match[1], peso: match[2] };
      });
      const { data: exist } = await supa.from("exercises")
        .select("*").eq("session_id", currentSession.id).eq("name", name);
      if(exist.length){
        await supa.from("exercises").update({ series: JSON.stringify(series) }).eq("id", exist[0].id);
      }
    }

    function startTimer(btn, seconds){
      const sticky = document.getElementById("timerSticky");
      clearInterval(timerInterval);
      let t = seconds;
      sticky.style.display="block";
      sticky.textContent = `‚è±Ô∏è ${t}s`;
      timerInterval = setInterval(()=>{
        t--;
        sticky.textContent = `‚è±Ô∏è ${t}s`;
        if(t<=0){ clearInterval(timerInterval); sticky.style.display="none"; }
      },1000);
    }

    function backToMenu(){
      document.querySelectorAll(".container").forEach(c=>c.classList.add("hidden"));
      document.getElementById("menu").classList.remove("hidden");
    }

    function showDashboard(){ alert("Dashboard in arrivo üí™"); }
    function showHistory(){ alert("Storico in sviluppo üß†"); }
  </script>
</body>
</html>
