<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --danger: #dc3545;
      --danger-dark: #c82333;
      --success: #28a745;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 8px;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #111;
      line-height: 1.5;
    }

    header {
      text-align: center;
      padding: 1.2rem;
      background: #ffffff;
      color: #111;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      padding: .7rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      margin: .3rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover { 
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn.danger { 
      background: var(--danger); 
    }
    .btn.danger:hover { 
      background: var(--danger-dark); 
    }
    .btn.success { 
      background: var(--success); 
    }
    .btn.warning { 
      background: var(--warning); 
      color: var(--dark);
    }
    .btn.secondary {
      background: var(--gray);
    }

    .exercise {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .exercise:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .exercise h3 {
      margin: 0 0 .3rem 0;
      color: var(--primary);
    }
    .exercise small {
      color: var(--gray);
      display: block;
      margin: .3rem 0;
    }
    .exercise .last-time {
      color: var(--success);
      font-weight: bold;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      flex-wrap: wrap;
    }

    .input-group label {
      font-weight: bold;
      min-width: 60px;
    }

    input {
      padding: .4rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 80px;
    }

    .series-list {
      margin-top: .4rem;
      font-size: .9rem;
      color: #333;
    }
    .series-list div {
      background: #eef3ff;
      padding: .3rem .5rem;
      margin: .2rem 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-serie {
      cursor: pointer;
      color: var(--danger);
      font-weight: bold;
    }

    .hidden { display: none; }

    #sticky-timer {
      position: fixed;
      bottom: 40%;
      left: 20px;
      background: var(--primary);
      color: white;
      padding: .7rem 1.2rem;
      border-radius: 50px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-weight: bold;
      z-index: 1000;
      display: none;
    }

    canvas {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      margin: 1rem 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: .7rem;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: var(--primary);
      color: white;
    }

    #loader {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:white;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:1.3rem;
      color:var(--primary);
      z-index:2000;
    }

    textarea {
      width:100%;
      min-height:80px;
      border-radius:8px;
      border:1px solid #ccc;
      padding:.7rem;
      resize:vertical;
      margin-top:.5rem;
      box-sizing: border-box;
    }

    .auto-save-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      font-size: 0.9rem;
      z-index: 1000;
      display: none;
    }

    .session-info {
      background: var(--light);
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Dashboard Styles */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .kpi-label {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .chart-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .period-selector {
      display: flex;
      gap: 0.5rem;
    }

    .period-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--primary);
      background: white;
      color: var(--primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .period-btn.active {
      background: var(--primary);
      color: white;
    }

    .insight-box {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .insight-title {
      font-weight: bold;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .record-badge {
      background: var(--success);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    .trend-neutral {
      color: var(--gray);
    }

    .muscle-balance {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }

    .muscle-item {
      flex: 1;
      min-width: 150px;
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .muscle-name {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .muscle-value {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .positive {
      color: var(--success);
    }

    .negative {
      color: var(--danger);
    }

    .neutral {
      color: var(--gray);
    }

    .summary {
      background:#fff;
      border-radius:8px;
      padding:1rem;
      margin-top:1rem;
      box-shadow:0 1px 6px rgba(0,0,0,0.1);
    }
    .motivational {
      text-align:center;
      font-weight:bold;
      margin:1rem 0;
      color:#28a745;
    }
    .error-msg {
      background: #ffe6e6;
      color: #d32f2f;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="loader">üèãÔ∏è‚Äç‚ôÇÔ∏è Caricamento...</div>
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button class="btn" onclick="app.startSession('A')">‚ñ∂ Giorno A</button>
    <button class="btn" onclick="app.startSession('B')">‚ñ∂ Giorno B</button>
    <button class="btn" onclick="app.showDashboard()">üìä Dashboard</button>
    <button class="btn" onclick="app.showHistory()">üìú Storico</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <div id="sticky-timer">‚è±Ô∏è 00s</div>
  <div id="auto-save-status" class="auto-save-status">‚úÖ Salvato automaticamente</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ‚ö†Ô∏è IMPORTANTE: Sostituisci con le TUE credenziali Supabase reali!
const SUPABASE_URL = "https://oyzouvusoysuhylijfdm.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95em91dnVzb3lzdWh5bGlqZmRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MjEyNjYsImV4cCI6MjA3NDk5NzI2Nn0.oIS0HpNZ6WiSF5zVZf9pxMc6NQIIB7uog2l2yR-ott0";

let supa;
try {
  supa = createClient(SUPABASE_URL, SUPABASE_KEY);
} catch(e) {
  document.body.innerHTML = `<div class="container"><div class="error-msg">‚ùå Errore connessione Supabase: ${e.message}<br>Verifica le credenziali!</div></div>`;
}

const schede = {
  A: [
    { nome:"Chest Press", muscolo:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
    { nome:"Shoulder Press", muscolo:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
    { nome:"Pectoral Machine", muscolo:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
    { nome:"Alzate Laterali", muscolo:"Spalle", come:"Braccia piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
    { nome:"Crunch", muscolo:"Addome", come:"Contrai l'addome.", att:"Non tirare il collo." }
  ],
  B: [
    { nome:"Lat Machine", muscolo:"Dorso", come:"Tira la barra al petto mantenendo il busto fermo.", att:"Non oscillare con la schiena." },
    { nome:"Rematore", muscolo:"Dorso", come:"Tira i manici verso l'addome.", att:"Non inarcare la schiena." },
    { nome:"Leg Press", muscolo:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
    { nome:"Leg Curl", muscolo:"Femorali", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
    { nome:"Plank", muscolo:"Core", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
  ]
};

const app = {
  currentSession: null,
  timerInterval: null,
  dashboardPeriod: 'all', // 'week', 'month', 'all'
  autoSaveTimeout: null,
  exerciseDefaults: {}, // Memorizza gli ultimi valori inseriti per ogni esercizio

  async startSession(day) {
    document.getElementById("loader").style.display = "flex";
    const today = new Date().toISOString().split("T")[0];
    
    try {
      // Cerca o crea la sessione di oggi
      let { data, error } = await supa
        .from("sessions")
        .select("*, exercises(*)")
        .eq("day", day)
        .eq("date", today)
        .maybeSingle();
      
      if (error) throw error;

      if (!data) {
        const { data: newSession, error: insertErr } = await supa
          .from("sessions")
          .insert([{ day, date: today, notes:"", total_volume:0, total_series:0 }])
          .select("*, exercises(*)")
          .single();
        
        if (insertErr) throw insertErr;
        this.currentSession = newSession;
      } else {
        this.currentSession = data;
      }

      await this.renderSession(day);
    } catch(e) {
      alert("‚ùå Errore: " + e.message);
      console.error(e);
    }
    
    document.getElementById("loader").style.display = "none";
  },

  async renderSession(day) {
    document.getElementById("menu").classList.add("hidden");
    const c = document.getElementById("session");
    c.classList.remove("hidden");

    // Carica i dati degli esercizi per questa sessione
    const exercisesData = this.currentSession.exercises || [];

    let html = `
      <div class="session-info">
        <h2>Sessione Giorno ${day} - ${new Date().toLocaleDateString('it-IT')}</h2>
        <div>
          <button class="btn secondary" onclick="app.autoSaveSession()">üíæ Salva ora</button>
          <button class="btn" onclick="app.finalizeSession()">‚úÖ Fine Sessione</button>
        </div>
      </div>
      <p><em>Le serie vengono salvate automaticamente quando aggiungi/modifichi</em></p>
    `;

    for (const ex of schede[day]) {
      const exerciseData = exercisesData.find(e => e.name === ex.nome) || { series: [] };
      const last = await this.getLastExercise(ex.nome);
      
      // Recupera i valori di default per questo esercizio
      const defaults = this.exerciseDefaults[ex.nome] || { rip: "", peso: "" };
      
      html += `
        <div class="exercise" data-name="${ex.nome}" data-muscolo="${ex.muscolo}">
          <h3>${ex.nome}</h3>
          <small>(${ex.muscolo})</small>
          <small>üëâ ${ex.come}</small>
          <small>‚ö†Ô∏è ${ex.att}</small>
          <small class="last-time"><b>Ultima volta:</b> ${last || "N/A"}</small>
          
          <div class="input-group">
            <label>Rip:</label>
            <input type="number" class="rip" min="1" value="${defaults.rip}" placeholder="8-12">
            <label>Peso:</label>
            <input type="number" class="peso" min="0" step="0.5" value="${defaults.peso}" placeholder="kg">
            <button class="btn" onclick="app.addSerie(this)">‚ûï Aggiungi Serie</button>
            <button class="btn" onclick="app.startTimer(60)">‚è±Ô∏è 60s</button>
            <button class="btn" onclick="app.startDynamicTimer(30,60,4)">‚è±Ô∏è Dinamico</button>
          </div>
          
          <div class="series-list" id="series-${ex.nome.replace(/\s+/g, '-')}">
            ${exerciseData.series.map((serie, index) => `
              <div data-index="${index}">
                ${serie.rip} x ${serie.peso}kg 
                <span class="delete-serie" onclick="app.deleteSerie('${ex.nome}', ${index})">üóë</span>
              </div>
            `).join('')}
          </div>
        </div>`;
    }

    html += `
      <div class="input-group">
        <textarea id="note" placeholder="Aggiungi note finali...">${this.currentSession.notes || ''}</textarea>
      </div>
      <button class="btn success" onclick="app.finalizeSession()">‚úÖ Fine Sessione e Salva Note</button>
      <button class="btn" onclick="app.backToMenu()">‚¨ÖÔ∏è Torna al Menu</button>
    `;

    c.innerHTML = html;
  },

  async addSerie(btn) {
    const ex = btn.closest(".exercise");
    const exName = ex.dataset.name;
    const ripInput = ex.querySelector(".rip");
    const pesoInput = ex.querySelector(".peso");
    
    const rip = ripInput.value;
    const peso = pesoInput.value;
    
    if (!rip || !peso) {
      alert("Inserisci ripetizioni e peso!");
      return;
    }

    // Salva i valori come default per questo esercizio
    this.exerciseDefaults[exName] = { rip, peso };

    try {
      // Recupera l'esercizio corrente dal database
      const { data: exerciseData, error } = await supa
        .from("exercises")
        .select("*")
        .eq("session_id", this.currentSession.id)
        .eq("name", exName)
        .maybeSingle();

      let series = [];
      
      if (exerciseData && exerciseData.series) {
        series = [...exerciseData.series];
      }
      
      // Aggiungi la nuova serie
      series.push({ rip: parseInt(rip), peso: parseFloat(peso) });
      
      // Calcola il volume per questo esercizio
      const volume = series.reduce((sum, s) => sum + (s.rip * s.peso), 0);
      
      if (exerciseData) {
        // Aggiorna l'esercizio esistente
        await supa
          .from("exercises")
          .update({ series, volume })
          .eq("id", exerciseData.id);
      } else {
        // Crea un nuovo esercizio
        await supa
          .from("exercises")
          .insert([{
            session_id: this.currentSession.id,
            name: exName,
            muscolo: ex.dataset.muscolo,
            series,
            volume
          }]);
      }
      
      // Aggiorna la lista visuale
      const list = document.getElementById(`series-${exName.replace(/\s+/g, '-')}`);
      const serieEl = document.createElement("div");
      serieEl.innerHTML = `${rip} x ${peso}kg <span class="delete-serie" onclick="app.deleteSerie('${exName}', ${series.length - 1})">üóë</span>`;
      list.appendChild(serieEl);
      
      // Mostra conferma salvataggio
      this.showAutoSaveStatus();
      
      // NON svuotare gli input - mantieni i valori per la prossima serie!
      
    } catch (e) {
      alert("‚ùå Errore nel salvare la serie: " + e.message);
      console.error(e);
    }
  },

  async deleteSerie(exName, serieIndex) {
    if (!confirm("Eliminare questa serie?")) return;
    
    try {
      // Recupera l'esercizio
      const { data: exerciseData, error } = await supa
        .from("exercises")
        .select("*")
        .eq("session_id", this.currentSession.id)
        .eq("name", exName)
        .single();

      if (error || !exerciseData) throw new Error("Esercizio non trovato");
      
      // Rimuovi la serie
      const series = [...exerciseData.series];
      series.splice(serieIndex, 1);
      
      // Aggiorna il volume
      const volume = series.reduce((sum, s) => sum + (s.rip * s.peso), 0);
      
      // Salva nel database
      await supa
        .from("exercises")
        .update({ series, volume })
        .eq("id", exerciseData.id);
      
      // Ricarica la vista
      await this.renderSession(this.currentSession.day);
      
      this.showAutoSaveStatus();
      
    } catch (e) {
      alert("‚ùå Errore nell'eliminare la serie: " + e.message);
      console.error(e);
    }
  },

  async autoSaveSession() {
    try {
      // Salva le note
      const notes = document.getElementById("note")?.value || "";
      
      await supa
        .from("sessions")
        .update({ notes })
        .eq("id", this.currentSession.id);
      
      this.showAutoSaveStatus();
      
    } catch (e) {
      console.error("Errore nel salvataggio automatico:", e);
    }
  },

  async finalizeSession() {
    await this.autoSaveSession();
    alert("‚úÖ Sessione completata e salvata!");
    this.backToMenu();
  },

  showAutoSaveStatus() {
    const statusEl = document.getElementById("auto-save-status");
    statusEl.style.display = "block";
    
    // Nascondi dopo 2 secondi
    setTimeout(() => {
      statusEl.style.display = "none";
    }, 2000);
  },

  startTimer(sec) {
    let time = sec;
    const timer = document.getElementById("sticky-timer");
    timer.style.display = "block";
    timer.textContent = `‚è±Ô∏è ${time}s`;
    
    clearInterval(this.timerInterval);
    this.timerInterval = setInterval(() => {
      time--;
      timer.textContent = `‚è±Ô∏è ${time}s`;
      if (time < 0) {
        clearInterval(this.timerInterval);
        timer.textContent = "‚úÖ Fine";
        setTimeout(() => timer.style.display = "none", 1500);
      }
    }, 1000);
  },

  startDynamicTimer(esecSec, recSec, serieTotali) {
    const timer = document.getElementById("sticky-timer");
    let serie = 1;
    
    const nextSerie = () => {
      if (serie > serieTotali) {
        timer.textContent = "üèÅ Completato!";
        setTimeout(() => timer.style.display = "none", 2000);
        return;
      }
      
      timer.style.display = "block";
      let t = esecSec;
      timer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
      
      const faseEsec = setInterval(() => {
        t--;
        timer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
        if (t < 0) {
          clearInterval(faseEsec);
          let r = recSec;
          const faseRec = setInterval(() => {
            r--;
            timer.textContent = `Recupero ${r}s`;
            if (r < 0) {
              clearInterval(faseRec);
              serie++;
              nextSerie();
            }
          }, 1000);
        }
      }, 1000);
    };
    
    nextSerie();
  },

  async getLastExercise(nome) {
    try {
      const { data, error } = await supa
        .from("exercises")
        .select("series, created_at")
        .eq("name", nome)
        .order("created_at", { ascending: false })
        .limit(1);

      if (error || !data || data.length === 0) return null;
      
      // Formatta la data in italiano
      const date = new Date(data[0].created_at);
      const formattedDate = date.toLocaleDateString('it-IT', { 
        day: 'numeric', 
        month: 'long'
      });
      
      return `${data[0].series.map(s => `${s.rip}x${s.peso}kg`).join(", ")} (${formattedDate})`;
    } catch (e) {
      return null;
    }
  },

async showDashboard() {
  document.getElementById("menu").classList.add("hidden");
  const dash = document.getElementById("dashboard");
  dash.classList.remove("hidden");
  
  // Mostra loader
  document.getElementById("loader").style.display = "flex";
  
  try {
    const { data: sessions } = await supa.from("sessions").select("*").order("date", { ascending: true });
    const { data: exercises } = await supa.from("exercises").select("*");

    if (!sessions || sessions.length === 0) {
      dash.innerHTML = `
        <h2>üìä Dashboard</h2>
        <p>Nessuna sessione registrata.</p>
        <button class="btn" onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>
      `;
      document.getElementById("loader").style.display = "none";
      return;
    }

    // Calcola metriche KPI
    const totalVolume = sessions.reduce((sum, s) => sum + (s.total_volume || 0), 0);
    const sessionCount = sessions.length;
    const seriesCount = sessions.reduce((sum, s) => sum + (s.total_series || 0), 0);
    const avgVolume = totalVolume / sessionCount;
    
    // Allenamenti questa settimana
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const weeklySessions = sessions.filter(s => new Date(s.date) >= oneWeekAgo).length;

    // Calcola PR per ogni esercizio
    const prData = {};
    exercises.forEach(ex => {
      if (!prData[ex.name] || ex.volume > prData[ex.name].volume) {
        prData[ex.name] = {
          volume: ex.volume,
          date: ex.created_at
        };
      }
    });

    // Calcola distribuzione per muscoli
    const muscleDistribution = {};
    exercises.forEach(ex => {
      muscleDistribution[ex.muscolo] = (muscleDistribution[ex.muscolo] || 0) + 1;
    });

    // Calcola volume per muscolo
    const muscleVolume = {};
    exercises.forEach(ex => {
      muscleVolume[ex.muscolo] = (muscleVolume[ex.muscolo] || 0) + ex.volume;
    });

    // Calcola totale volume per muscolo
    const totalMuscleVolume = Object.values(muscleVolume).reduce((a, b) => a + b, 0);

    // Calcola percentuali
    const musclePercentages = {};
    Object.keys(muscleVolume).forEach(muscle => {
      musclePercentages[muscle] = (muscleVolume[muscle] / totalMuscleVolume * 100).toFixed(1);
    });

    // Trova muscolo pi√π e meno allenato
    const muscles = Object.keys(musclePercentages);
    const mostTrained = muscles.reduce((a, b) => musclePercentages[a] > musclePercentages[b] ? a : b);
    const leastTrained = muscles.reduce((a, b) => musclePercentages[a] < musclePercentages[b] ? a : b);

    // Calcola differenza dalla media
    const avgPercentage = 100 / muscles.length;
    const mostDiff = ((musclePercentages[mostTrained] - avgPercentage) / avgPercentage * 100).toFixed(1);
    const leastDiff = ((musclePercentages[leastTrained] - avgPercentage) / avgPercentage * 100).toFixed(1);

    // Prepara dati per grafici
    const labels = sessions.map(s => s.date);
    const volumeData = sessions.map(s => s.total_volume || 0);
    const seriesData = sessions.map(s => s.total_series || 0);
    
    // Colori per i giorni
    const dayColors = sessions.map(s => s.day === 'A' ? '#007bff' : '#28a745');

    dash.innerHTML = `
      <h2>üìä Dashboard Avanzata</h2>
      
      <!-- KPI Cards -->
      <div class="dashboard">
        <div class="kpi-card">
          <div>üèãÔ∏è</div>
          <div class="kpi-value">${totalVolume.toFixed(0)}</div>
          <div class="kpi-label">Volume Totale (kg)</div>
        </div>
        <div class="kpi-card">
          <div>üìÖ</div>
          <div class="kpi-value">${sessionCount}</div>
          <div class="kpi-label">Sessioni Totali</div>
        </div>
        <div class="kpi-card">
          <div>üî¢</div>
          <div class="kpi-value">${seriesCount}</div>
          <div class="kpi-label">Serie Totali</div>
        </div>
        <div class="kpi-card">
          <div>üìä</div>
          <div class="kpi-value">${avgVolume.toFixed(1)}</div>
          <div class="kpi-label">Media Volume/Sessione</div>
        </div>
        <div class="kpi-card">
          <div>üóìÔ∏è</div>
          <div class="kpi-value">${weeklySessions}</div>
          <div class="kpi-label">Allenamenti Settimana</div>
        </div>
      </div>

      <!-- Grafico Volume -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>üìà Volume Totale per Sessione</h3>
          <div class="period-selector">
            <button class="period-btn ${this.dashboardPeriod === 'week' ? 'active' : ''}" onclick="app.setDashboardPeriod('week')">7g</button>
            <button class="period-btn ${this.dashboardPeriod === 'month' ? 'active' : ''}" onclick="app.setDashboardPeriod('month')">30g</button>
            <button class="period-btn ${this.dashboardPeriod === 'all' ? 'active' : ''}" onclick="app.setDashboardPeriod('all')">Tutti</button>
          </div>
        </div>
        <canvas id="chartVolume" height="80"></canvas>
      </div>

      <!-- Grafico Serie -->
      <div class="chart-container">
        <h3>üìä Serie Totali per Sessione</h3>
        <canvas id="chartSeries" height="80"></canvas>
      </div>

      <!-- Bilanci Muscolari -->
      <div class="chart-container">
        <h3>ü•ß Distribuzione Serie per Muscolo</h3>
        <canvas id="chartMuscles" height="80"></canvas>
        <div class="muscle-balance">
          ${Object.keys(musclePercentages).map(muscle => `
            <div class="muscle-item">
              <div class="muscle-name">${muscle}</div>
              <div class="muscle-value ${muscle === mostTrained ? 'positive' : muscle === leastTrained ? 'negative' : 'neutral'}">
                ${musclePercentages[muscle]}%
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Personal Records -->
      <div class="chart-container">
        <h3>üèÜ Personal Records</h3>
        <table>
          <thead>
            <tr>
              <th>Esercizio</th>
              <th>Ultimo Volume</th>
              <th>Miglior Volume</th>
              <th>Diff.</th>
              <th>Ultima Data</th>
            </tr>
          </thead>
          <tbody>
            ${Object.keys(prData).map(exName => {
              const lastExercise = exercises
                .filter(ex => ex.name === exName)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
              
              const lastVolume = lastExercise ? lastExercise.volume : 0;
              const bestVolume = prData[exName].volume;
              const diff = lastVolume && bestVolume ? ((lastVolume - bestVolume) / bestVolume * 100).toFixed(1) : 0;
              const trendClass = diff > 5 ? 'trend-up' : diff < -5 ? 'trend-down' : 'trend-neutral';
              const trendIcon = diff > 5 ? 'üî∫' : diff < -5 ? 'üîª' : '=';
              
              return `
                <tr>
                  <td>${exName}</td>
                  <td>${lastVolume.toFixed(0)} kg</td>
                  <td>${bestVolume.toFixed(0)} kg</td>
                  <td class="${trendClass}">${trendIcon} ${Math.abs(diff)}%</td>
                  <td>${new Date(lastExercise.created_at).toLocaleDateString('it-IT')}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>

      <!-- Note & Insights -->
      <div class="insight-box">
        <div class="insight-title">üí° Note & Insights Intelligenti</div>
        <p>${this.generateInsights(sessions, exercises, musclePercentages, mostTrained, leastTrained, mostDiff, leastDiff)}</p>
      </div>

      <button class="btn" onclick="app.backToMenu()">‚¨ÖÔ∏è Torna al Menu</button>
    `;

    // Inizializza i grafici
    this.initCharts(labels, volumeData, seriesData, dayColors, muscleDistribution, muscleVolume);

  } catch (e) {
    dash.innerHTML = `
      <h2>üìä Dashboard</h2>
      <div class="error-msg">Errore nel caricamento dei dati: ${e.message}</div>
      <button class="btn" onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>
    `;
  }
  
  document.getElementById("loader").style.display = "none";
},

initCharts(labels, volumeData, seriesData, dayColors, muscleDistribution, muscleVolume) {
  // Grafico Volume
  new Chart(document.getElementById("chartVolume"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Volume Totale",
        data: volumeData,
        borderColor: "#007bff",
        backgroundColor: "rgba(0,123,255,0.1)",
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Grafico Serie
  new Chart(document.getElementById("chartSeries"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Serie Totali",
        data: seriesData,
        backgroundColor: dayColors,
        borderColor: dayColors.map(c => c),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Grafico Muscoli
  new Chart(document.getElementById("chartMuscles"), {
    type: "pie",
    data: {
      labels: Object.keys(muscleDistribution),
      datasets: [{
        data: Object.values(muscleDistribution),
        backgroundColor: ["#f94144", "#f9c74f", "#90be6d", "#577590", "#43aa8b", "#ff6f00"]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'right'
        }
      }
    }
  });
},

generateInsights(sessions, exercises, musclePercentages, mostTrained, leastTrained, mostDiff, leastDiff) {
  const totalSessions = sessions.length;
  const weeklyAvg = totalSessions / (totalSessions > 0 ? Math.ceil((new Date() - new Date(sessions[0].date)) / (7 * 24 * 60 * 60 * 1000)) : 1);
  
  let insight = `Hai completato ${totalSessions} sessioni di allenamento. `;
  
  if (weeklyAvg >= 3) {
    insight += `Con una media di ${weeklyAvg.toFixed(1)} sessioni a settimana, sei molto costante! `;
  } else if (weeklyAvg >= 2) {
    insight += `Mantieni una buona frequenza di ${weeklyAvg.toFixed(1)} sessioni a settimana. `;
  } else {
    insight += `Potresti aumentare la frequenza delle sessioni per ottenere miglioramenti pi√π rapidi. `;
  }
  
  insight += `Il gruppo muscolare pi√π allenato √® il ${mostTrained} (+${mostDiff}% sopra la media). `;
  insight += `Mentre il ${leastTrained} √® il meno stimolato (${leastDiff}% sotto la media). `;
  
  // Suggerimenti basati sui dati
  if (parseFloat(mostDiff) > 20) {
    insight += `Considera di bilanciare maggiormente l'allenamento concentrandoti sul ${leastTrained}.`;
  } else if (parseFloat(mostDiff) < 10) {
    insight += `Ottima distribuzione dell'allenamento tra i vari gruppi muscolari!`;
  }
  
  return insight;
},

  setDashboardPeriod(period) {
  this.dashboardPeriod = period;
  this.showDashboard();
},
  
  async showHistory() {
    // Implementazione storico (come prima)
    document.getElementById("menu").classList.add("hidden");
    const hist = document.getElementById("history");
    hist.classList.remove("hidden");
    hist.innerHTML = `<h2>üìú Storico</h2>`;

    try {
      const { data: sessions } = await supa.from("sessions").select("*, exercises(*)").order("date", { ascending: false });

      if (!sessions || sessions.length === 0) {
        hist.innerHTML += "<p>Nessuna sessione salvata.</p>";
      } else {
        sessions.forEach(s => {
          const div = document.createElement("div");
          div.classList.add("exercise");
          div.innerHTML = `
            <b>${s.day}</b> - ${s.date}<br>
            ${s.exercises && s.exercises.length > 0
              ? s.exercises.map(e => `<u>${e.name}</u>: ${e.series.map(ser => `${ser.rip}x${ser.peso}kg`).join(", ")}`).join("<br>")
              : "<i>Nessun esercizio</i>"
            }
            <p><b>Note:</b> ${s.notes || "-"}</p>
            <button class="btn" onclick="app.editSession(${s.id})">‚úèÔ∏è Modifica</button>
            <button class="btn danger" onclick="app.deleteSession(${s.id})">üóë Elimina</button>
          `;
          hist.appendChild(div);
        });
      }

      hist.innerHTML += `<button class="btn" onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>`;
    } catch (e) {
      hist.innerHTML += `<div class="error-msg">Errore: ${e.message}</div>`;
    }
  },

  async deleteSession(id) {
    if (!confirm("Eliminare questa sessione?")) return;
    try {
      await supa.from("sessions").delete().eq("id", id);
      alert("‚úÖ Sessione eliminata");
      this.showHistory();
    } catch (e) {
      alert("‚ùå Errore: " + e.message);
    }
  },

  async editSession(id) {
    try {
      const { data } = await supa.from("sessions").select("*, exercises(*)").eq("id", id).single();
      if (!data) return alert("Errore");
      this.currentSession = data;
      await this.renderSession(data.day);
    } catch (e) {
      alert("‚ùå Errore: " + e.message);
    }
  },

  backToMenu() {
    document.getElementById("session").classList.add("hidden");
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("history").classList.add("hidden");
    document.getElementById("menu").classList.remove("hidden");
  }
};

window.app = app;

window.addEventListener("load", () => {
  document.getElementById("loader").style.display = "none";
});

// Salvataggio automatico quando l'utente lascia la pagina
window.addEventListener('beforeunload', (event) => {
  if (app.currentSession) {
    app.autoSaveSession();
  }
});
</script>
</body>
</html>

