<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>🏋️ Gym Tracker PRO+</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --green:#28a745; --bg:#111; --fg:#eee; --soft:#1c1c1c;
}
body {font-family:'Segoe UI',sans-serif;margin:0;background:var(--bg);color:var(--fg);transition:all .3s;}
header {background:var(--soft);padding:1rem;text-align:center;font-size:1.4rem;font-weight:bold;}
button {margin:.3rem;padding:.6rem 1rem;border:none;border-radius:8px;background:var(--green);color:#fff;font-weight:600;cursor:pointer;transition:.3s;}
button:hover {opacity:.85;}
.container {max-width:900px;padding:1rem;margin:auto;animation:fadeIn .6s;}
.exercise {border:1px solid #333;background:#181818;padding:.9rem;margin-bottom:.9rem;border-radius:8px;transition:.3s;}
.exercise.fadeIn {animation:fadeIn .4s;}
@keyframes fadeIn {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.series-list div {background:#222;padding:.3rem;margin:.2rem 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center;animation:fadeIn .3s;}
.series-list div span {font-size:.8rem;color:#bbb;}
.summary-box {background:#222;border-radius:10px;padding:1rem;margin-top:1rem;text-align:center;box-shadow:0 0 15px rgba(0,0,0,.3);}
.muscolo-Petto{border-left:5px solid #e53935;}
.muscolo-Spalle{border-left:5px solid #ff9800;}
.muscolo-Dorso{border-left:5px solid #2196f3;}
.muscolo-Gambe{border-left:5px solid #4caf50;}
.muscolo-Addome{border-left:5px solid #ffeb3b;}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.4rem;z-index:999;display:none;}
.planner{width:100%;border-collapse:collapse;margin-top:1rem;}
.planner th,.planner td{border:1px solid #555;padding:.5rem;text-align:center;}
.planner th{background:#222;}
</style>
</head>
<body>
<header>🏋️ Gym Tracker PRO+</header>

<div id="loader">🔥 Niente scuse, solo progressi 💪</div>

<div class="container" id="menu">
  <button onclick="startSession('A')">▶ Giorno A</button>
  <button onclick="startSession('B')">▶ Giorno B</button>
  <button onclick="showDashboard()">📊 Dashboard</button>
  <button onclick="showHistory()">📜 Storico</button>
</div>

<div class="container hidden" id="session"></div>
<div class="container hidden" id="dashboard"></div>
<div class="container hidden" id="history"></div>

<script>
const supa=supabase.createClient("https://oyzouvusoysuhylijfdm.supabase.co","sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm");
let currentSession=null,isExisting=false,sessionId=null;

const schede={
A:[{nome:"Chest Press",muscoli:"Petto"},{nome:"Shoulder Press",muscoli:"Spalle"},{nome:"Pectoral Machine",muscoli:"Petto"},{nome:"Alzate Laterali",muscoli:"Spalle"},{nome:"Crunch",muscoli:"Addome"}],
B:[{nome:"Lat Machine",muscoli:"Dorso"},{nome:"Rematore Macchina",muscoli:"Dorso"},{nome:"Leg Press",muscoli:"Gambe"},{nome:"Leg Curl",muscoli:"Gambe"},{nome:"Plank",muscoli:"Addome"}]
};

function showLoader(show=true){document.getElementById("loader").style.display=show?"flex":"none";}

async function startSession(day){
  showLoader(true);
  document.getElementById("menu").classList.add("hidden");
  const now=new Date();
  const since=new Date(now.getTime()-24*60*60*1000).toISOString();
  const {data}=await supa.from("sessions").select("*").eq("day",day).gte("date",since).limit(1);
  if(data&&data.length>0){currentSession=data[0];isExisting=true;sessionId=currentSession.id;}
  else{currentSession={day,date:now.toISOString(),exercises:[]};isExisting=false;}
  showLoader(false);
  renderSession(day);
}

function renderSession(day){
  const c=document.getElementById("session");
  c.innerHTML=`<h2>Sessione Giorno ${day}</h2>`;
  const exercises=currentSession.exercises.length?currentSession.exercises:schede[day];
  for(const ex of exercises){
    const list=(ex.series||[]).map((s,i)=>makeSerieHTML(s,ex.nome,i)).join("");
    c.innerHTML+=`
      <div class="exercise muscolo-${ex.muscoli}">
        <h3>${ex.nome} <small>(${ex.muscoli})</small></h3>
        Rip:<input type="number" class="rip"> Peso:<input type="number" class="peso">
        <button onclick="addSerie(this)">➕ Serie</button>
        <div class="series-list">${list}</div>
      </div>`;
  }
  c.innerHTML+=`
    <h3>Aggiungi esercizio personalizzato</h3>
    <input type="text" id="newName" placeholder="Nome esercizio">
    <select id="newMuscle">
      <option>Petto</option><option>Spalle</option><option>Dorso</option><option>Gambe</option><option>Addome</option>
    </select>
    <select id="preset">
      <option value="">Senza preset</option>
      <option value="3x12">3x12</option>
      <option value="4x8">4x8</option>
      <option value="5x5">5x5</option>
    </select>
    <button onclick="addCustomExercise()">➕ Aggiungi</button>
    <button onclick="saveSession()">💾 Salva</button>
    <button onclick="backToMenu()">⬅️ Indietro</button>`;
  c.classList.remove("hidden");
}

function makeSerieHTML(txt,exName,i){
  return `<div>${txt}<span><button style="background:none;color:#ff4444" onclick="delSerie('${exName}',${i})">🗑</button></span></div>`;
}

function addSerie(btn){
  const p=btn.parentElement;
  const rip=p.querySelector(".rip").value;
  const peso=p.querySelector(".peso").value;
  if(!rip||!peso)return alert("Inserisci rip e peso");
  const name=p.querySelector("h3").innerText.split("(")[0].trim();
  const sTxt=`${rip}x${peso}kg`;
  const ex=currentSession.exercises.find(e=>e.nome===name);
  if(ex)ex.series.push(sTxt); else currentSession.exercises.push({nome:name,muscoli:"Altro",series:[sTxt]});
  p.querySelector(".series-list").innerHTML+=makeSerieHTML(sTxt,name,0);
}

function delSerie(exName,i){
  const ex=currentSession.exercises.find(e=>e.nome===exName);
  if(!ex)return;
  ex.series.splice(i,1);
  renderSession(currentSession.day);
}

function addCustomExercise(){
  const name=document.getElementById("newName").value;
  const muscolo=document.getElementById("newMuscle").value;
  const preset=document.getElementById("preset").value;
  if(!name)return alert("Inserisci un nome");
  const ex={nome:name,muscoli:muscolo,series:[]};
  if(preset){
    const [serie,rip]=preset.split("x");
    for(let i=0;i<serie;i++) ex.series.push(`${rip}x?kg`);
  }
  currentSession.exercises.push(ex);
  renderSession(currentSession.day);
}

async function saveSession(){
  showLoader(true);
  if(isExisting){
    await supa.from("sessions").update({exercises:currentSession.exercises}).eq("id",sessionId);
    alert("✅ Sessione aggiornata!");
  }else{
    const {data}=await supa.from("sessions").insert([currentSession]).select("id");
    sessionId=data[0].id;isExisting=true;alert("✅ Nuova sessione salvata!");
  }
  showLoader(false);
}

async function showDashboard(){
  showLoader(true);
  document.getElementById("menu").classList.add("hidden");
  const d=document.getElementById("dashboard");d.classList.remove("hidden");
  const {data}=await supa.from("sessions").select("*").order("date",{ascending:true});
  showLoader(false);
  if(!data||!data.length){d.innerHTML="<p>Nessuna sessione.</p>";return;}

  // 🔹 Calcola % miglioramento medio per esercizio
  const map={};
  data.forEach(s=>{
    s.exercises.forEach(e=>{
      const avg=e.series.filter(x=>x.includes("kg")).reduce((a,b)=>a+parseInt(b.split("x")[1]),0)/(e.series.length||1);
      if(!map[e.nome]) map[e.nome]=[];
      map[e.nome].push(avg);
    });
  });
  const improve=[];
  for(const k in map){if(map[k].length>1){const diff=((map[k].at(-1)-map[k].at(-2))/map[k].at(-2))*100;improve.push(`${k}: ${diff>0?'+':''}${diff.toFixed(1)}%`);}}

  const last7=data.slice(-7);
  let table=`<h2>📆 Planner Settimanale</h2><table class="planner"><tr><th>Data</th><th>Sessione</th><th>Stato</th><th>Miglioramento</th></tr>`;
  last7.forEach(s=>{
    const day=new Date(s.date).toLocaleDateString();
    const dayType=s.day;
    table+=`<tr><td>${day}</td><td>${dayType}</td><td>✅</td><td>${improve.join("<br>")}</td></tr>`;
  });
  table+="</table>";
  d.innerHTML=table+`<button onclick="backToMenu()">⬅️ Indietro</button>`;
}

async function showHistory(){
  showLoader(true);
  const h=document.getElementById("history");
  document.getElementById("menu").classList.add("hidden");
  h.classList.remove("hidden");
  const {data}=await supa.from("sessions").select("*").order("date",{ascending:false});
  showLoader(false);
  h.innerHTML="<h2>📜 Storico</h2>";
  data.forEach(s=>{
    h.innerHTML+=`<div><b>${new Date(s.date).toLocaleDateString()} (${s.day})</b><br>
    ${s.exercises.map(e=>`${e.nome}: ${e.series.join(", ")}`).join("<br>")}<hr></div>`;
  });
  h.innerHTML+=`<button onclick="backToMenu()">⬅️</button>`;
}

function backToMenu(){
  document.querySelectorAll(".container").forEach(c=>c.classList.add("hidden"));
  document.getElementById("menu").classList.remove("hidden");
}
</script>
</body>
</html>
