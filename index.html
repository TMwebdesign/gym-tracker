<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>🏋️ Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --green:#28a745; --bg:#111; --fg:#eee;
      --soft:#1c1c1c; --warn:#ff9800; --danger:#e53935;
    }
    body { font-family:'Segoe UI',sans-serif; margin:0; background:var(--bg); color:var(--fg);}
    header { background:var(--soft); padding:1rem; text-align:center; font-size:1.4rem; font-weight:bold;}
    button {
      margin:.3rem; padding:.6rem 1rem; border:none; border-radius:8px;
      background:var(--green); color:#fff; font-weight:600; cursor:pointer; transition:.3s;
    }
    button:hover { opacity:.85; }
    .container { max-width:900px; padding:1rem; margin:auto;}
    .exercise { border:1px solid #333; background:#181818; padding:.9rem; margin-bottom:.9rem; border-radius:8px;}
    input { padding:.4rem; margin:.2rem; width:80px; border-radius:4px; border:1px solid #444; background:#222; color:#fff;}
    .series-list { margin:.5rem 0; font-size:.9rem; color:#ccc;}
    .timer { display:block; font-weight:bold; color:#0f0; margin-top:.5rem;}
    .progress-bar { height:8px; border-radius:4px; background:#333; overflow:hidden; margin-top:.4rem;}
    .progress-inner { height:100%; width:0%; background:var(--green); transition:width 1s linear;}
    .hidden { display:none; }
    canvas { background:#fff; border-radius:8px; margin-top:1rem; }
    .summary-box {
      background:#222; border-radius:10px; padding:1rem; margin-top:1rem; text-align:center;
      box-shadow:0 0 15px rgba(0,0,0,.3);
    }
    .summary-box h3 { color:#7aff8f; }
    .bottom-nav {
      position:fixed; bottom:0; left:0; right:0; background:#222;
      display:flex; justify-content:space-around; padding:.5rem 0; border-top:1px solid #444;
    }
    .bottom-nav button { flex:1; background:none; color:#ccc; border:none; font-size:1rem; }
    .bottom-nav button.active { color:var(--green);}
  </style>
</head>
<body>
  <header>🏋️ Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="startSession('A')">▶ Giorno A</button>
    <button onclick="startSession('B')">▶ Giorno B</button>
    <button onclick="showDashboard()">📊 Dashboard</button>
    <button onclick="showHistory()">📜 Storico</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="summary"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <div class="bottom-nav">
    <button onclick="backToMenu()">🏠</button>
    <button onclick="showDashboard()">📈</button>
    <button onclick="showHistory()">📜</button>
    <button onclick="toggleTheme()">🌙</button>
  </div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script>
    // 🗝️ Supabase
    const supa = supabase.createClient(
      "https://oyzouvusoysuhylijfdm.supabase.co",
      "sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm"
    );

    let currentSession=null,totalSeconds=0,totalTimer=null;

    const schede={
      A:[
        {nome:"Chest Press",muscoli:"Petto"},
        {nome:"Shoulder Press",muscoli:"Spalle"},
        {nome:"Pectoral Machine",muscoli:"Petto"},
        {nome:"Alzate Laterali",muscoli:"Spalle"},
        {nome:"Crunch",muscoli:"Addome"}
      ],
      B:[
        {nome:"Lat Machine",muscoli:"Dorso"},
        {nome:"Rematore Macchina",muscoli:"Dorso"},
        {nome:"Leg Press",muscoli:"Gambe"},
        {nome:"Leg Curl",muscoli:"Gambe"},
        {nome:"Plank",muscoli:"Addome"}
      ]
    };

    // 🚀 Avvia sessione
    async function startSession(day){
      currentSession={day,date:new Date().toISOString(),exercises:[]};
      totalSeconds=0;
      document.getElementById("menu").classList.add("hidden");
      const c=document.getElementById("session");
      c.innerHTML=`<h2>Sessione Giorno ${day}</h2><div id="totalTime">⏱ 0:00</div>`;
      totalTimer=setInterval(()=>{totalSeconds++;document.getElementById("totalTime").innerText=`⏱ ${Math.floor(totalSeconds/60)}:${(totalSeconds%60).toString().padStart(2,"0")}`;},1000);

      for(const ex of schede[day]){
        c.innerHTML+=`
          <div class="exercise">
            <h3>${ex.nome} <small>(${ex.muscoli})</small></h3>
            Rip:<input type="number" class="rip"> Peso:<input type="number" class="peso">
            <button onclick="addSerie(this)">➕</button>
            <div class="series-list"></div>
          </div>`;
      }
      c.innerHTML+=`<button onclick="saveSession()">💾 Salva e mostra riepilogo</button>
                    <button onclick="backToMenu()">⬅️ Indietro</button>`;
      c.classList.remove("hidden");
    }

    function addSerie(btn){
      const p=btn.parentElement;
      const rip=p.querySelector(".rip").value;
      const peso=p.querySelector(".peso").value;
      if(!rip||!peso)return alert("Inserisci rip e peso");
      p.querySelector(".series-list").innerHTML+=`<div>${rip}x${peso}kg</div>`;
      p.querySelector(".rip").value="";
      p.querySelector(".peso").value="";
    }

    // 💾 Salva su Supabase
    async function saveSession(){
      clearInterval(totalTimer);
      const ex=document.querySelectorAll(".exercise");
      const data=[];
      ex.forEach(e=>{
        const name=e.querySelector("h3").innerText;
        const s=Array.from(e.querySelectorAll(".series-list div")).map(d=>d.innerText);
        if(s.length>0)data.push({name,series:s});
      });
      if(data.length===0)return alert("Nessuna serie registrata");
      currentSession.exercises=data;
      await supa.from("sessions").insert([currentSession]);
      showSummary(data);
    }

    // 🧾 Riepilogo automatico
    async function showSummary(exercises){
      const s=document.getElementById("summary");
      document.getElementById("session").classList.add("hidden");
      s.classList.remove("hidden");

      let totalSeries=0,totalWeight=0;
      const groups={Petto:0,Spalle:0,Dorso:0,Gambe:0,Addome:0};
      exercises.forEach(e=>{
        const g=Object.keys(groups).find(k=>e.name.toLowerCase().includes(k.toLowerCase()));
        if(g)groups[g]+=e.series.length;
        e.series.forEach(s=>{
          const match=s.match(/(\d+)x(\d+)/);
          if(match){
            totalSeries++;
            totalWeight+=parseInt(match[1])*parseInt(match[2]);
          }
        });
      });
      const totalMin=Math.floor(totalSeconds/60);
      const intensity=totalSeries>25?8.5:6;
      const calories=(intensity*70*(totalSeconds/3600)).toFixed(0);

      // 🏆 PR storico e sessione max
      const {data:history}=await supa.from("sessions").select("*");
      let maxWeight=0,maxTime=0;
      history?.forEach(sess=>{
        let localWeight=0;
        sess.exercises.forEach(e=>e.series.forEach(s=>{
          const m=s.match(/(\d+)x(\d+)/);
          if(m)localWeight+=parseInt(m[1])*parseInt(m[2]);
        }));
        if(localWeight>maxWeight)maxWeight=localWeight;
        const timeEst=(sess.exercises.length*2+10)*2; // stima tempo storico
        if(timeEst>maxTime)maxTime=timeEst;
      });

      s.innerHTML=`
        <div class="summary-box">
          <h3>🏁 Riepilogo Sessione</h3>
          <p>Durata: ${totalMin} min</p>
          <p>Serie totali: ${totalSeries}</p>
          <p>Peso totale sollevato: ${totalWeight} kg</p>
          <p>Calorie stimate: ${calories} kcal</p>
          <hr>
          <p>🏆 Record storico carico massimo: ${maxWeight} kg</p>
          <p>🕒 Sessione più lunga: ${Math.floor(maxTime/60)} min</p>
          <canvas id="muscleChart" width="300" height="200"></canvas>
          <button onclick="backToMenu()">🏠 Torna al menu</button>
        </div>`;
      
      const ctx=document.getElementById("muscleChart").getContext("2d");
      new Chart(ctx,{
        type:"pie",
        data:{
          labels:Object.keys(groups),
          datasets:[{data:Object.values(groups),backgroundColor:["#7aff8f","#ffc107","#03a9f4","#e91e63","#9c27b0"]}]
        },
        options:{plugins:{legend:{labels:{color:"#fff"}}}}
      });
    }

    // 📊 Dashboard
    async function showDashboard(){
      document.getElementById("menu").classList.add("hidden");
      const d=document.getElementById("dashboard");
      d.classList.remove("hidden");
      const {data}=await supa.from("sessions").select("*");
      if(!data||!data.length){d.innerHTML="<p>Nessuna sessione registrata.</p>";return;}
      const labels=data.map(s=>new Date(s.date).toLocaleDateString());
      const values=data.map(s=>{
        let w=0; s.exercises.forEach(e=>e.series.forEach(sr=>{
          const m=sr.match(/(\d+)x(\d+)/); if(m)w+=parseInt(m[1])*parseInt(m[2]);
        }));
        return w;
      });
      d.innerHTML=`<h2>📈 Dashboard</h2><canvas id="chart"></canvas>
                   <button onclick="backToMenu()">⬅️</button>`;
      const ctx=document.getElementById("chart").getContext("2d");
      new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Peso Totale",data:values,borderColor:"#7aff8f"}]}});
    }

    // 📜 Storico
    async function showHistory(){
      document.getElementById("menu").classList.add("hidden");
      const h=document.getElementById("history");
      h.classList.remove("hidden");
      const {data}=await supa.from("sessions").select("*").order("date",{ascending:false});
      h.innerHTML="<h2>📜 Storico</h2>";
      data.forEach(s=>{
        h.innerHTML+=`<div><b>${new Date(s.date).toLocaleDateString()} (${s.day})</b><br>
          ${s.exercises.map(e=>`${e.name}: ${e.series.join(", ")}`).join("<br>")}<hr></div>`;
      });
      h.innerHTML+=`<button onclick="backToMenu()">⬅️ Indietro</button>`;
    }

    function backToMenu(){
      document.querySelectorAll(".container").forEach(c=>c.classList.add("hidden"));
      document.getElementById("menu").classList.remove("hidden");
    }
    function toggleTheme(){document.body.classList.toggle("light-mode");}
  </script>
</body>
</html>
