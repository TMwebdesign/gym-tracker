<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #111;
    }
    header {
      text-align: center;
      padding: 1.2rem;
      background: #ffffff;
      color: #111;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: .7rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
      margin: .3rem;
    }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }

    .exercise {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .exercise h3 {
      margin: 0 0 .3rem 0;
      color: #007bff;
    }
    .exercise small {
      color: #666;
      display: block;
      margin: .3rem 0;
    }
    input {
      padding: .4rem;
      margin: .2rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 70px;
    }
    .series-list {
      margin-top: .4rem;
      font-size: .9rem;
      color: #333;
    }
    .series-list div {
      background: #eef3ff;
      padding: .3rem .5rem;
      margin: .2rem 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-serie {
      cursor: pointer;
      color: #d33;
      font-weight: bold;
    }
    .hidden { display: none; }

    #sticky-timer {
      position: fixed;
      bottom: 40%;
      left: 20px;
      background: #007bff;
      color: white;
      padding: .7rem 1.2rem;
      border-radius: 50px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-weight: bold;
      z-index: 1000;
      display: none;
    }

    canvas {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      margin: 1rem 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: .7rem;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }

    #loader {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:white;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:1.3rem;
      color:#007bff;
      z-index:2000;
    }

    textarea {
      width:100%;
      min-height:80px;
      border-radius:8px;
      border:1px solid #ccc;
      padding:.7rem;
      resize:vertical;
      margin-top:.5rem;
      box-sizing: border-box;
    }
    .summary {
      background:#fff;
      border-radius:8px;
      padding:1rem;
      margin-top:1rem;
      box-shadow:0 1px 6px rgba(0,0,0,0.1);
    }
    .motivational {
      text-align:center;
      font-weight:bold;
      margin:1rem 0;
      color:#28a745;
    }
    .error-msg {
      background: #ffe6e6;
      color: #d32f2f;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="loader">üèãÔ∏è‚Äç‚ôÇÔ∏è Caricamento...</div>
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="app.startSession('A')">‚ñ∂ Giorno A</button>
    <button onclick="app.startSession('B')">‚ñ∂ Giorno B</button>
    <button onclick="app.showDashboard()">üìä Dashboard</button>
    <button onclick="app.showHistory()">üìú Storico</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <div id="sticky-timer">‚è±Ô∏è 00s</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ‚ö†Ô∏è IMPORTANTE: Sostituisci con le TUE credenziali Supabase reali!
const SUPABASE_URL = "https://oyzouvusoysuhylijfdm.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95em91dnVzb3lzdWh5bGlqZmRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MjEyNjYsImV4cCI6MjA3NDk5NzI2Nn0.oIS0HpNZ6WiSF5zVZf9pxMc6NQIIB7uog2l2yR-ott0";

let supa;
try {
  supa = createClient(SUPABASE_URL, SUPABASE_KEY);
} catch(e) {
  document.body.innerHTML = `<div class="container"><div class="error-msg">‚ùå Errore connessione Supabase: ${e.message}<br>Verifica le credenziali!</div></div>`;
}

const schede = {
  A: [
    { nome:"Chest Press", muscolo:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
    { nome:"Shoulder Press", muscolo:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
    { nome:"Pectoral Machine", muscolo:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
    { nome:"Alzate Laterali", muscolo:"Spalle", come:"Braccia piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
    { nome:"Crunch", muscolo:"Addome", come:"Contrai l'addome.", att:"Non tirare il collo." }
  ],
  B: [
    { nome:"Lat Machine", muscolo:"Dorso", come:"Tira la barra al petto mantenendo il busto fermo.", att:"Non oscillare con la schiena." },
    { nome:"Rematore", muscolo:"Dorso", come:"Tira i manici verso l'addome.", att:"Non inarcare la schiena." },
    { nome:"Leg Press", muscolo:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
    { nome:"Leg Curl", muscolo:"Femorali", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
    { nome:"Plank", muscolo:"Core", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
  ]
};

const app = {
  currentSession: null,
  timerInterval: null,

  async startSession(day) {
    document.getElementById("loader").style.display = "flex";
    const today = new Date().toISOString().split("T")[0];
    
    try {
      let { data, error } = await supa.from("sessions").select("*").eq("day", day).eq("date", today).maybeSingle();
      
      if (error) throw error;

      if (!data) {
        const { data: newSession, error: insertErr } = await supa
          .from("sessions")
          .insert([{ day, date: today, notes:"", total_volume:0, total_series:0 }])
          .select()
          .single();
        
        if (insertErr) throw insertErr;
        this.currentSession = newSession;
      } else {
        this.currentSession = data;
      }

      await this.renderSession(day);
    } catch(e) {
      alert("‚ùå Errore: " + e.message);
      console.error(e);
    }
    
    document.getElementById("loader").style.display = "none";
  },

  async renderSession(day) {
    document.getElementById("menu").classList.add("hidden");
    const c = document.getElementById("session");
    c.classList.remove("hidden");

    let html = `<h2>Sessione Giorno ${day}</h2>`;

    for (const ex of schede[day]) {
      const last = await this.getLastExercise(ex.nome);
      html += `
        <div class="exercise" data-name="${ex.nome}" data-muscolo="${ex.muscolo}">
          <h3>${ex.nome}</h3>
          <small>(${ex.muscolo})</small>
          <small>üëâ ${ex.come}</small>
          <small>‚ö†Ô∏è ${ex.att}</small>
          <small><b>Ultima volta:</b> ${last || "N/A"}</small><br>
          Rip: <input type="number" class="rip" min="1" value=""> 
          Peso: <input type="number" class="peso" min="0" step="0.5" value=""> 
          <button onclick="app.addSerie(this)">‚ûï Serie</button>
          <button onclick="app.startTimer(60)">‚è±Ô∏è 60s</button>
          <button onclick="app.startDynamicTimer(30,60,4)">‚è±Ô∏è Dinamico</button>
          <div class="series-list"></div>
        </div>`;
    }

    html += `
      <textarea id="note" placeholder="Aggiungi note finali...">${this.currentSession.notes || ''}</textarea>
      <button onclick="app.saveSession()">üíæ Salva sessione</button>
      <button onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>
    `;

    c.innerHTML = html;
  },

  addSerie(btn) {
    const ex = btn.closest(".exercise");
    const rip = ex.querySelector(".rip").value;
    const peso = ex.querySelector(".peso").value;
    if (!rip || !peso) return alert("Inserisci ripetizioni e peso!");
    
    const list = ex.querySelector(".series-list");
    const serieEl = document.createElement("div");
    serieEl.innerHTML = `${rip} x ${peso}kg <span class="delete-serie" onclick="app.deleteSerie(this)">üóë</span>`;
    list.appendChild(serieEl);
    
    ex.querySelector(".rip").value = "";
    ex.querySelector(".peso").value = "";
  },

  deleteSerie(el) { 
    el.parentElement.remove(); 
  },

  startTimer(sec) {
    let time = sec;
    const timer = document.getElementById("sticky-timer");
    timer.style.display = "block";
    timer.textContent = `‚è±Ô∏è ${time}s`;
    
    clearInterval(this.timerInterval);
    this.timerInterval = setInterval(() => {
      time--;
      timer.textContent = `‚è±Ô∏è ${time}s`;
      if (time < 0) {
        clearInterval(this.timerInterval);
        timer.textContent = "‚úÖ Fine";
        setTimeout(() => timer.style.display = "none", 1500);
      }
    }, 1000);
  },

  startDynamicTimer(esecSec, recSec, serieTotali) {
    const timer = document.getElementById("sticky-timer");
    let serie = 1;
    
    const nextSerie = () => {
      if (serie > serieTotali) {
        timer.textContent = "üèÅ Completato!";
        setTimeout(() => timer.style.display = "none", 2000);
        return;
      }
      
      timer.style.display = "block";
      let t = esecSec;
      timer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
      
      const faseEsec = setInterval(() => {
        t--;
        timer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
        if (t < 0) {
          clearInterval(faseEsec);
          let r = recSec;
          const faseRec = setInterval(() => {
            r--;
            timer.textContent = `Recupero ${r}s`;
            if (r < 0) {
              clearInterval(faseRec);
              serie++;
              nextSerie();
            }
          }, 1000);
        }
      }, 1000);
    };
    
    nextSerie();
  },

  async saveSession() {
    const list = document.querySelectorAll(".exercise");
    let exData = [];
    let totalVol = 0;

    list.forEach(ex => {
      const name = ex.dataset.name;
      const muscolo = ex.dataset.muscolo;
      const series = Array.from(ex.querySelectorAll(".series-list div")).map(s => {
        const match = s.innerText.match(/(\d+(?:\.\d+)?)\s*x\s*(\d+(?:\.\d+)?)/);
        if (match) {
          const rip = +match[1];
          const peso = +match[2];
          totalVol += rip * peso;
          return { rip, peso };
        }
        return null;
      }).filter(Boolean);
      
      if (series.length > 0) exData.push({ name, muscolo, series });
    });

    const notes = document.getElementById("note").value;
    const totalSeries = exData.reduce((a, b) => a + b.series.length, 0);

    try {
      // Aggiorna sessione
      const { error: sessionErr } = await supa
        .from("sessions")
        .update({ notes, total_volume: totalVol, total_series: totalSeries })
        .eq("id", this.currentSession.id);

      if (sessionErr) throw sessionErr;

      // Elimina vecchi esercizi
      await supa.from("exercises").delete().eq("session_id", this.currentSession.id);

      // Inserisci nuovi esercizi
      if (exData.length > 0) {
        const exercises = exData.map(ex => ({
          session_id: this.currentSession.id,
          name: ex.name,
          muscolo: ex.muscolo,
          series: ex.series,
          volume: ex.series.reduce((a, b) => a + b.rip * b.peso, 0)
        }));

        const { error: exErr } = await supa.from("exercises").insert(exercises);
        if (exErr) throw exErr;
      }

      alert("‚úÖ Sessione salvata con successo!");
      this.backToMenu();
    } catch (e) {
      alert("‚ùå Errore salvataggio: " + e.message);
      console.error(e);
    }
  },

  async getLastExercise(nome) {
    try {
      const { data, error } = await supa
        .from("exercises")
        .select("series, created_at")
        .eq("name", nome)
        .order("created_at", { ascending: false })
        .limit(1);

      if (error || !data || data.length === 0) return null;
      return data[0].series.map(s => `${s.rip}x${s.peso}kg`).join(", ");
    } catch (e) {
      return null;
    }
  },

  async showDashboard() {
    document.getElementById("menu").classList.add("hidden");
    const dash = document.getElementById("dashboard");
    dash.classList.remove("hidden");
    dash.innerHTML = `
      <h2>üìä Dashboard</h2>
      <canvas id="chartSeries" height="80"></canvas>
      <canvas id="chartMuscoli" height="80"></canvas>
      <div class="summary" id="summary"></div>
      <button onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>
    `;

    try {
      const { data: sessions } = await supa.from("sessions").select("*").order("date", { ascending: true });
      const { data: exercises } = await supa.from("exercises").select("session_id, muscolo, volume");

      if (!sessions || sessions.length === 0) {
        dash.innerHTML += "<p>Nessuna sessione registrata.</p>";
        return;
      }

      // Grafico serie
      const labels = sessions.map(d => d.date);
      const seriesCounts = sessions.map(d => d.total_series || 0);

      new Chart(document.getElementById("chartSeries"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Serie totali",
            data: seriesCounts,
            borderColor: "#007bff",
            backgroundColor: "rgba(0,123,255,0.1)",
            tension: 0.3
          }]
        }
      });

      // Grafico muscoli
      const muscoliMap = {};
      exercises.forEach(e => {
        muscoliMap[e.muscolo] = (muscoliMap[e.muscolo] || 0) + 1;
      });

      new Chart(document.getElementById("chartMuscoli"), {
        type: "pie",
        data: {
          labels: Object.keys(muscoliMap),
          datasets: [{
            data: Object.values(muscoliMap),
            backgroundColor: ["#f94144", "#f9c74f", "#90be6d", "#577590", "#43aa8b", "#ff6f00"]
          }]
        }
      });

      const totalVol = sessions.reduce((a, b) => a + (b.total_volume || 0), 0);
      document.getElementById("summary").innerHTML = `
        <h3>üìà Totale Volume: ${totalVol.toFixed(1)} kg</h3>
        <p>Media serie: ${(seriesCounts.reduce((a, b) => a + b, 0) / seriesCounts.length).toFixed(1)}</p>
      `;
    } catch (e) {
      dash.innerHTML += `<div class="error-msg">Errore: ${e.message}</div>`;
    }
  },

  async showHistory() {
    document.getElementById("menu").classList.add("hidden");
    const hist = document.getElementById("history");
    hist.classList.remove("hidden");
    hist.innerHTML = `<h2>üìú Storico</h2>`;

    try {
      const { data: sessions } = await supa.from("sessions").select("*").order("date", { ascending: false });
      const { data: exercises } = await supa.from("exercises").select("*");

      if (!sessions || sessions.length === 0) {
        hist.innerHTML += "<p>Nessuna sessione salvata.</p>";
      } else {
        sessions.forEach(s => {
          const exs = exercises.filter(e => e.session_id === s.id);
          const div = document.createElement("div");
          div.classList.add("exercise");
          div.innerHTML = `
            <b>${s.day}</b> - ${s.date}<br>
            ${exs.length > 0
              ? exs.map(e => `<u>${e.name}</u>: ${e.series.map(ser => `${ser.rip}x${ser.peso}kg`).join(", ")}`).join("<br>")
              : "<i>Nessun esercizio</i>"
            }
            <p><b>Note:</b> ${s.notes || "-"}</p>
            <button onclick="app.editSession(${s.id})">‚úèÔ∏è Modifica</button>
            <button class="danger" onclick="app.deleteSession(${s.id})">üóë Elimina</button>
          `;
          hist.appendChild(div);
        });
      }

      hist.innerHTML += `<button onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>`;
    } catch (e) {
      hist.innerHTML += `<div class="error-msg">Errore: ${e.message}</div>`;
    }
  },

  async deleteSession(id) {
    if (!confirm("Eliminare questa sessione?")) return;
    try {
      await supa.from("sessions").delete().eq("id", id);
      alert("‚úÖ Sessione eliminata");
      this.showHistory();
    } catch (e) {
      alert("‚ùå Errore: " + e.message);
    }
  },

  async editSession(id) {
    try {
      const { data } = await supa.from("sessions").select("*").eq("id", id).single();
      if (!data) return alert("Errore");
      this.currentSession = data;
      await this.renderEditSession(data);
    } catch (e) {
      alert("‚ùå Errore: " + e.message);
    }
  },

  async renderEditSession(session) {
    document.getElementById("history").classList.add("hidden");
    const c = document.getElementById("session");
    c.classList.remove("hidden");
    c.innerHTML = `<h2>‚úèÔ∏è Modifica ${session.day} - ${session.date}</h2>`;

    try {
      const { data: exercises } = await supa.from("exercises").select("*").eq("session_id", session.id);

      if (exercises && exercises.length > 0) {
        exercises.forEach(ex => {
          const div = document.createElement("div");
          div.classList.add("exercise");
          div.dataset.name = ex.name;
          div.dataset.muscolo = ex.muscolo;
          div.innerHTML = `
            <h3>${ex.name}</h3>
            <small>(${ex.muscolo})</small>
            <div class="series-list">
              ${ex.series.map(s => `<div>${s.rip}x${s.peso}kg <span class='delete-serie' onclick='app.deleteSerie(this)'>üóë</span></div>`).join("")}
            </div>
            Rip: <input type="number" class="rip" min="1"> 
            Peso: <input type="number" class="peso" min="0" step="0.5"> 
            <button onclick="app.addSerie(this)">‚ûï Serie</button>
          `;
          c.appendChild(div);
        });
      }

      c.innerHTML += `
        <textarea id="note" placeholder="Note...">${session.notes || ""}</textarea>
        <button onclick="app.saveSession()">üíæ Salva</button>
        <button onclick="app.backToMenu()">‚¨ÖÔ∏è Torna</button>
      `;
    } catch (e) {
      c.innerHTML += `<div class="error-msg">Errore: ${e.message}</div>`;
    }
  },

  backToMenu() {
    document.getElementById("session").classList.add("hidden");
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("history").classList.add("hidden");
    document.getElementById("menu").classList.remove("hidden");
  }
};

window.app = app;

window.addEventListener("load", () => {
  document.getElementById("loader").style.display = "none";
});
</script>
</body>
</html>

