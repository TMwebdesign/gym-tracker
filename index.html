<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#111; color:#eee; }
    header { background:#222; padding:1rem; text-align:center; font-size:1.3rem; font-weight:bold; }
    button { margin:.3rem; padding:.6rem 1rem; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer; }
    button:hover { background:#218838; }
    .hidden { display:none; }
    .container { max-width:900px; padding:1rem; margin:auto; }
    .exercise { border:1px solid #444; padding:.7rem; margin-bottom:.7rem; border-radius:6px; }
    .exercise h3 { margin:.2rem 0; }
    .exercise small { color:#aaa; display:block; margin:.3rem 0; }
    input { padding:.3rem; margin:.2rem; width:80px; }
    .series-list { margin:.5rem 0; font-size:.9rem; color:#ccc; }
    .timer { font-weight:bold; color:#0f0; margin-left:.5rem; }
    canvas { background:#fff; border-radius:6px; margin-top:1rem; }
    .heatmap { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-top:1rem; }
    .heatmap div { width:20px; height:20px; background:#333; }
    .heatmap .active { background:#28a745; }
    .light-mode { background:#fafafa; color:#111; }
    .light-mode header { background:#ddd; color:#000; }
    table { border-collapse: collapse; margin-top:1rem; width:100%; }
    th, td { border:1px solid #555; padding:.5rem; text-align:center; }
    th { background:#333; }
    .actions button { background:#dc3545; }
    .actions button:hover { background:#b52d3b; }
  </style>
</head>
<body class="dark-mode">
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="startSession('A')">‚ñ∂ Avvia Giorno A</button>
    <button onclick="startSession('B')">‚ñ∂ Avvia Giorno B</button>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showHistory()">üìú Storico</button>
    <button onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script>
    // üîë Config Supabase
    const supa = supabase.createClient(
      "https://oyzouvusoysuhylijfdm.supabase.co",
      "sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm"
    );

    let currentSession = null;
    let timerInterval = null;

    // üìã Schede Giorno A/B
    const schede = {
      A: [
        { nome:"Chest Press", muscoli:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
        { nome:"Shoulder Press", muscoli:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
        { nome:"Pectoral Machine", muscoli:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
        { nome:"Alzate Laterali", muscoli:"Spalle", come:"Braccia piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
        { nome:"Crunch", muscoli:"Addome", come:"Contrai l‚Äôaddome.", att:"Non tirare il collo." }
      ],
      B: [
        { nome:"Lat Machine", muscoli:"Dorso", come:"Tira la barra al petto.", att:"Non oscillare con la schiena." },
        { nome:"Rematore Macchina", muscoli:"Dorso", come:"Tira i manici verso l‚Äôaddome.", att:"Non inarcare la schiena." },
        { nome:"Leg Press", muscoli:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
        { nome:"Leg Curl", muscoli:"Gambe", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
        { nome:"Plank", muscoli:"Addome", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
      ]
    };

    // üöÄ Avvia sessione
    async function startSession(day) {
      currentSession = { day, date:new Date().toISOString(), exercises:[] };
      document.getElementById("menu").classList.add("hidden");
      const c = document.getElementById("session");
      c.innerHTML = `<h2>Sessione Giorno ${day}</h2>`;
      for (const ex of schede[day]) {
        const last = await getLastExercise(ex.nome);
        c.innerHTML += `
          <div class="exercise">
            <h3>${ex.nome} <small>(${ex.muscoli})</small></h3>
            <small>üëâ ${ex.come}</small>
            <small>‚ö†Ô∏è ${ex.att}</small>
            <small><b>Ultima volta:</b> ${last || "N/A"}</small><br>
            Rip: <input type="number" class="rip" min="1">
            Peso: <input type="number" class="peso" min="0">
            <button onclick="addSerie(this)">‚ûï Serie</button>
            <button onclick="startTimer(this,90)">‚è±Ô∏è Recupero</button>
            <button onclick="startDynamicTimer(this)">‚è±Ô∏è+ Dinamico</button>
            <span class="timer"></span>
            <div class="series-list"></div>
          </div>`;
      }
      c.innerHTML += `<button onclick="saveSession()">üíæ Salva sessione</button>
                      <button onclick="backToMenu()">‚¨ÖÔ∏è Indietro</button>`;
      c.classList.remove("hidden");
    }
    window.startSession = startSession;

    // ‚ûï Aggiungi serie
    function addSerie(btn) {
      const parent = btn.parentElement;
      const rip = parent.querySelector(".rip").value;
      const peso = parent.querySelector(".peso").value;
      if (!rip || !peso) return alert("Inserisci ripetizioni e peso");
      const list = parent.querySelector(".series-list");
      list.innerHTML += `<div>${rip} x ${peso}kg</div>`;
      parent.querySelector(".rip").value = "";
      parent.querySelector(".peso").value = "";
    }
    window.addSerie = addSerie;

    // ‚è±Ô∏è Timer normale
    function startTimer(btn, seconds) {
      const timerEl = btn.nextElementSibling;
      let time = seconds;
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timerEl.textContent = `${time}s`;
        if (time<=5 && time>0) document.getElementById("beep").play();
        if (time<=0) clearInterval(timerInterval);
        time--;
      },1000);
    }
    window.startTimer = startTimer;

    // ‚è±Ô∏è Timer dinamico
    async function startDynamicTimer(btn) {
      const seriesCount = prompt("Quante serie?");
      if(!seriesCount) return;
      const execution = 30; // tempo esecuzione
      const recovery = 60;  // recupero
      let s = 1;
      const timerEl = btn.parentElement.querySelector(".timer");
      function doSerie() {
        let t = execution;
        timerEl.textContent=`Serie ${s}/${seriesCount} in corso...`;
        const int = setInterval(()=>{
          timerEl.textContent=`Serie ${s}/${seriesCount} - ${t}s`;
          t--;
          if(t<0){
            clearInterval(int);
            if(s<seriesCount){
              s++;
              let r=recovery;
              const recInt=setInterval(()=>{
                timerEl.textContent=`Recupero ${r}s`;
                if(r<=5) document.getElementById("beep").play();
                r--;
                if(r<0){clearInterval(recInt); doSerie();}
              },1000);
            }
          }
        },1000);
      }
      doSerie();
    }
    window.startDynamicTimer = startDynamicTimer;

    // üíæ Salva sessione
    async function saveSession() {
      const list = document.querySelectorAll(".exercise");
      list.forEach(ex=>{
        const name = ex.querySelector("h3").innerText;
        const series = Array.from(ex.querySelectorAll(".series-list div")).map(d=>d.innerText);
        currentSession.exercises.push({ name, series });
      });
      const { error } = await supa.from("sessions").insert([currentSession]);
      if(error) alert("Errore salvataggio: "+error.message);
      else { alert("Sessione salvata ‚úÖ"); backToMenu(); }
    }
    window.saveSession = saveSession;

    // ‚è™ Indietro
    function backToMenu() {
      document.getElementById("session").classList.add("hidden");
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("history").classList.add("hidden");
      document.getElementById("menu").classList.remove("hidden");
    }
    window.backToMenu = backToMenu;

    // üìå Ultima volta esercizio
    async function getLastExercise(nome) {
      const { data } = await supa.from("sessions").select("*").order("date",{ascending:false}).limit(1);
      if(data && data.length>0){
        const ex = data[0].exercises.find(e=>e.name.includes(nome));
        if(ex) return ex.series.join(", ");
      }
      return null;
    }

    // üìä Dashboard
    async function showDashboard() {
      document.getElementById("menu").classList.add("hidden");
      const dash=document.getElementById("dashboard");
      dash.classList.remove("hidden");
      dash.innerHTML=`<h2>üìä Dashboard</h2>
        <canvas id="chart" width="400" height="200"></canvas>
        <div class="heatmap" id="heatmap"></div>
        <h3>üèÜ PR per esercizio</h3>
        <div id="prTable"></div>
        <h3>‚ö° Distribuzione gruppi muscolari</h3>
        <canvas id="pie" width="400" height="200"></canvas>
        <button onclick="backToMenu()">‚¨ÖÔ∏è Indietro</button>`;
      const { data } = await supa.from("sessions").select("*").order("date",{ascending:true});
      drawChart(data);
      drawHeatmap(data);
      drawPR(data);
      drawPie(data);
    }
    window.showDashboard = showDashboard;

    function drawChart(data){
      const ctx=document.getElementById("chart").getContext("2d");
      const labels=data.map(d=>new Date(d.date).toLocaleDateString());
      const values=data.map(d=>d.exercises.reduce((t,e)=>t+e.series.length,0));
      new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Serie totali",data:values,borderColor:"green"}]}});
    }

    function drawHeatmap(data){
      const map=document.getElementById("heatmap"); map.innerHTML="";
      const days={};
      data.forEach(d=>days[new Date(d.date).toISOString().split("T")[0]]=true);
      for(let i=0;i<30;i++){
        const box=document.createElement("div");
        const day=new Date(); day.setDate(day.getDate()-i);
        if(days[day.toISOString().split("T")[0]]) box.classList.add("active");
        map.appendChild(box);
      }
    }

    function drawPR(data){
      const pr={};
      data.forEach(d=>{
        d.exercises.forEach(ex=>{
          ex.series.forEach(s=>{
            const match=s.match(/(\d+)\s*x\s*(\d+)/);
            if(match){
              const rip=parseInt(match[1]),peso=parseInt(match[2]);
              if(!pr[ex.name] || peso>pr[ex.name].peso){
                const oneRM=Math.round(peso*(1+rip/30));
                pr[ex.name]={peso,rip,oneRM};
              }
            }
          });
        });
      });
      const c=document.getElementById("prTable");
      c.innerHTML="<table><tr><th>Esercizio</th><th>Peso max</th><th>Rip</th><th>1RM</th></tr>";
      for(const [n,v] of Object.entries(pr)) c.innerHTML+=`<tr><td>${n}</td><td>${v.peso}kg</td><td>${v.rip}</td><td>${v.oneRM}kg</td></tr>`;
      c.innerHTML+="</table>";
    }

    function drawPie(data){
      const muscoli={};
      data.forEach(d=>{
        d.exercises.forEach(ex=>{
          const m=schede.A.concat(schede.B).find(e=>ex.name.includes(e.nome))?.muscoli || "Altro";
          muscoli[m]=(muscoli[m]||0)+ex.series.length;
        });
      });
      const ctx=document.getElementById("pie").getContext("2d");
      new Chart(ctx,{type:"pie",data:{labels:Object.keys(muscoli),datasets:[{data:Object.values(muscoli),backgroundColor:["#f00","#0f0","#00f","#ff0","#0ff"]}]}})
    }

    // üìú Storico
    async function showHistory(){
      document.getElementById("menu").classList.add("hidden");
      const hist=document.getElementById("history");
      hist.classList.remove("hidden");
      hist.innerHTML=`<h2>üìú Storico</h2>`;
      const { data }=await supa.from("sessions").select("*").order("date",{ascending:false});
      data.forEach(d=>{
        const div=document.createElement("div");
        div.innerHTML=`<b>${d.day}</b> - ${new Date(d.date).toLocaleDateString()}<br>
        ${d.exercises.map(e=>`${e.name}: ${e.series.join(", ")}`).join("<br>")}
        <div class="actions">
          <button onclick="deleteSession('${d.id}')">Elimina</button>
        </div><hr>`;
        hist.appendChild(div);
      });
      hist.innerHTML+=`<button onclick="backToMenu()">‚¨ÖÔ∏è Indietro</button>`;
    }
    window.showHistory=showHistory;

    async function deleteSession(id){
      if(confirm("Eliminare sessione?")){
        await supa.from("sessions").delete().eq("id",id);
        showHistory();
      }
    }

    // üåô/‚òÄÔ∏è Tema
    function toggleTheme(){document.body.classList.toggle("light-mode");document.body.classList.toggle("dark-mode");}
    window.toggleTheme=toggleTheme;

    // üõ†Ô∏è PWA Service Worker
    if("serviceWorker" in navigator){
      const swCode=`self.addEventListener("install",e=>{e.waitUntil(caches.open("gym-cache").then(c=>c.addAll(["."])))});
      self.addEventListener("fetch",e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
      const blob=new Blob([swCode],{type:"text/javascript"});
      const swUrl=URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl);
    }
  </script>
</body>
</html>
