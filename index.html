<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#111; color:#eee; }
    header { background:#222; padding:1rem; text-align:center; font-size:1.3rem; font-weight:bold; }
    button { margin:.3rem; padding:.6rem 1rem; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer; }
    button:hover { background:#218838; }
    .hidden { display:none; }
    .container { max-width:900px; padding:1rem; margin:auto; }
    .exercise { border:1px solid #444; padding:.7rem; margin-bottom:.7rem; border-radius:6px; }
    .exercise h3 { margin:.2rem 0; }
    .exercise small { color:#aaa; display:block; margin:.3rem 0; }
    input { padding:.3rem; margin:.2rem; width:80px; }
    .series-list { margin:.5rem 0; font-size:.9rem; color:#ccc; }
    .timer { font-weight:bold; color:#0f0; margin-left:.5rem; }
    canvas { background:#fff; border-radius:6px; margin-top:1rem; }
    .heatmap { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-top:1rem; }
    .heatmap div { width:20px; height:20px; background:#333; }
    .heatmap .active { background:#28a745; }
    .light-mode { background:#fafafa; color:#111; }
    .light-mode header { background:#ddd; color:#000; }
    table { border-collapse: collapse; margin-top:1rem; width:100%; }
    th, td { border:1px solid #555; padding:.5rem; text-align:center; }
    th { background:#333; }
    .edit-input { width:60px; }
  </style>
</head>
<body class="dark-mode">
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button id="btnA">‚ñ∂ Avvia Giorno A</button>
    <button id="btnB">‚ñ∂ Avvia Giorno B</button>
    <button id="btnDashboard">üìä Dashboard</button>
    <button id="btnHistory">üìú Storico</button>
    <button id="btnTheme">üåô/‚òÄÔ∏è</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import "https://cdn.jsdelivr.net/npm/chart.js";

    // üîë Config Firebase (sostituisci col tuo)
    const firebaseConfig = {
      apiKey: "AIzaSyCiOFFDXtnCgLVb9CTs4Q-QU0UlLParN_s",
      authDomain: "pale-ee7ea.firebaseapp.com",
      projectId: "pale-ee7ea",
      storageBucket: "pale-ee7ea.appspot.com",
      messagingSenderId: "494736253739",
      appId: "1:494736253739:web:4719c6b1076ae9bc281b6e"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentDay = null;
    let timerInterval = null;

    // üìã Schede Giorno A/B con muscoli
    const schede = {
      A: [
        { nome:"Chest Press", muscolo:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
        { nome:"Shoulder Press", muscolo:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
        { nome:"Pectoral Machine", muscolo:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
        { nome:"Alzate Laterali", muscolo:"Spalle", come:"Braccia leggermente piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
        { nome:"Addominali Crunch", muscolo:"Addome", come:"Contrai l‚Äôaddome, piccolo movimento.", att:"Non tirare il collo." }
      ],
      B: [
        { nome:"Lat Machine", muscolo:"Dorsali", come:"Tira la barra al petto mantenendo il busto fermo.", att:"Non oscillare con la schiena." },
        { nome:"Rematore Macchina", muscolo:"Dorsali", come:"Tira i manici verso l‚Äôaddome.", att:"Non inarcare la schiena." },
        { nome:"Leg Press", muscolo:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
        { nome:"Leg Curl", muscolo:"Gambe", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
        { nome:"Plank", muscolo:"Addome", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
      ]
    };

    // üîπ Helpers
    function todayKey(day) {
      const d = new Date().toISOString().split("T")[0];
      return `${day}-${d}`;
    }

    // üöÄ Avvia sessione
    async function startSession(day) {
      currentDay = day;
      document.getElementById("menu").classList.add("hidden");
      const c = document.getElementById("session");

      const sessionId = todayKey(day);
      const docRef = doc(db, "sessions", sessionId);
      const snap = await getDoc(docRef);
      let sessionData = snap.exists() ? snap.data() : { day, date: new Date(), exercises: [] };

      c.innerHTML = `<h2>Sessione Giorno ${day}</h2>`;
      for (const ex of schede[day]) {
        const last = await getLastExercise(ex.nome, day);
        const current = sessionData.exercises.find(e=>e.name===ex.nome);
        const savedSeries = current ? current.series : [];

        c.innerHTML += `
          <div class="exercise">
            <h3>${ex.nome}</h3>
            <small>üí™ Muscoli: ${ex.muscolo}</small>
            <small>üëâ ${ex.come}</small>
            <small>‚ö†Ô∏è ${ex.att}</small>
            <small><b>Ultima volta:</b> ${last || "N/A"}</small><br>
            Rip: <input type="number" class="rip" min="1"> 
            Peso: <input type="number" class="peso" min="0"> 
            <button class="btnAddSerie">‚ûï Serie</button>
            <button class="btnTimer">‚è±Ô∏è Recupero</button>
            <button class="btnDynTimer">‚è±Ô∏è Timer+</button>
            <span class="timer"></span>
            <div class="series-list">${savedSeries.map(s=>`<div>${s}</div>`).join("")}</div>
          </div>`;
      }
      c.innerHTML += `<button id="btnSave">üíæ Salva sessione</button>
                      <button id="btnBack">‚¨ÖÔ∏è Torna</button>`;
      c.classList.remove("hidden");

      // Bind
      c.querySelectorAll(".btnAddSerie").forEach(b => b.addEventListener("click", () => addSerie(b)));
      c.querySelectorAll(".btnTimer").forEach(b => b.addEventListener("click", () => startTimer(b,90)));
      c.querySelectorAll(".btnDynTimer").forEach(b => b.addEventListener("click", () => dynamicTimer(b,30,60,3)));
      document.getElementById("btnSave").addEventListener("click", saveSession);
      document.getElementById("btnBack").addEventListener("click", backToMenu);
    }

    function addSerie(btn) {
      const parent = btn.parentElement;
      const rip = parent.querySelector(".rip").value;
      const peso = parent.querySelector(".peso").value;
      if (!rip || !peso) return alert("Inserisci ripetizioni e peso");
      const list = parent.querySelector(".series-list");
      list.innerHTML += `<div>${rip} x ${peso}kg</div>`;
      parent.querySelector(".rip").value = "";
      parent.querySelector(".peso").value = "";
    }

    function startTimer(btn, seconds) {
      const timerEl = btn.nextElementSibling;
      let time = seconds;
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timerEl.textContent = `${time}s`;
        if (time<=5 && time>0) document.getElementById("beep").play();
        if (time<=0) clearInterval(timerInterval);
        time--;
      },1000);
    }

    function dynamicTimer(btn, execTime, restTime, sets) {
      const timerEl = btn.nextElementSibling;
      let setCount = 0;
      function runSet() {
        let t = execTime;
        timerEl.textContent = `Esecuzione ${++setCount}/${sets}`;
        let intv = setInterval(()=>{
          timerEl.textContent = `${t}s esecuzione`;
          if(t<=0) {
            clearInterval(intv);
            if(setCount<sets) startRest();
          }
          t--;
        },1000);
      }
      function startRest() {
        let r=restTime;
        let intv=setInterval(()=>{
          timerEl.textContent = `${r}s recupero`;
          if(r<=5 && r>0) document.getElementById("beep").play();
          if(r<=0){ clearInterval(intv); runSet(); }
          r--;
        },1000);
      }
      runSet();
    }

    async function saveSession() {
      const sessionId = todayKey(currentDay);
      const list = document.querySelectorAll(".exercise");
      const exercises=[];
      list.forEach(ex=>{
        const name = ex.querySelector("h3").innerText;
        const series = Array.from(ex.querySelectorAll(".series-list div")).map(d=>d.innerText);
        exercises.push({ name, series });
      });
      await setDoc(doc(db,"sessions",sessionId), { day: currentDay, date:new Date(), exercises });
      alert("Sessione salvata ‚úÖ");
      backToMenu();
    }

    function backToMenu() {
      document.getElementById("session").classList.add("hidden");
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("history").classList.add("hidden");
      document.getElementById("menu").classList.remove("hidden");
    }

    async function showDashboard() {
      document.getElementById("menu").classList.add("hidden");
      const dash = document.getElementById("dashboard");
      dash.classList.remove("hidden");
      dash.innerHTML = `<h2>üìä Dashboard</h2>
        <canvas id="chart" width="400" height="200"></canvas>
        <canvas id="muscleChart" width="400" height="200"></canvas>
        <button id="btnBackDash">‚¨ÖÔ∏è Torna</button>`;
      document.getElementById("btnBackDash").addEventListener("click", backToMenu);

      const q = query(collection(db,"sessions"), orderBy("date","asc"));
      const snap = await getDocs(q);
      const data = []; snap.forEach(doc=>data.push(doc.data()));
      drawChart(data);
      drawMuscles(data);
    }

    function drawChart(data) {
      const ctx = document.getElementById("chart").getContext("2d");
      const labels = data.map(d=>new Date(d.date).toLocaleDateString());
      const values = data.map(d=>d.exercises.reduce((tot,e)=>tot+e.series.length,0));
      new Chart(ctx,{ type:"line", data:{ labels, datasets:[{ label:"Serie totali", data:values, borderColor:"green" }] } });
    }

    function drawMuscles(data) {
      const stats={};
      data.forEach(d=>d.exercises.forEach(e=>{
        const exInfo = [...schede.A,...schede.B].find(x=>x.nome===e.name);
        if(!exInfo) return;
        stats[exInfo.muscolo] = (stats[exInfo.muscolo]||0)+e.series.length;
      }));
      const ctx=document.getElementById("muscleChart").getContext("2d");
      new Chart(ctx,{ type:"pie", data:{ labels:Object.keys(stats), datasets:[{ data:Object.values(stats), backgroundColor:["#f00","#0f0","#00f","#ff0","#0ff"] }] } });
    }

    async function showHistory() {
      document.getElementById("menu").classList.add("hidden");
      const hist=document.getElementById("history");
      hist.classList.remove("hidden");
      hist.innerHTML=`<h2>üìú Storico</h2>`;
      const q=query(collection(db,"sessions"),orderBy("date","desc"));
      const snap=await getDocs(q);
      snap.forEach(async docSnap=>{
        const d=docSnap.data();
        const div=document.createElement("div");
        div.innerHTML=`<b>${d.day}</b> - ${new Date(d.date).toLocaleDateString()} 
          <button class="editBtn">üìù Modifica</button>
          <button class="delBtn">üóëÔ∏è Elimina</button><br>
          ${d.exercises.map(e=>`${e.name}: ${e.series.join(", ")}`).join("<br>")}<hr>`;
        hist.appendChild(div);

        div.querySelector(".delBtn").addEventListener("click", async()=>{
          if(confirm("Eliminare sessione?")){ await deleteDoc(doc(db,"sessions",docSnap.id)); location.reload(); }
        });
        div.querySelector(".editBtn").addEventListener("click", ()=>{
          div.innerHTML=`<h4>Modifica ${d.day} - ${new Date(d.date).toLocaleDateString()}</h4>`;
          d.exercises.forEach((e,ei)=>{
            div.innerHTML+=`<b>${e.name}</b><br>`+e.series.map((s,si)=>`<input class="edit-input" id="ex-${ei}-${si}" value="${s}">`).join("")+"<br>";
          });
          const save=document.createElement("button");
          save.textContent="üíæ Salva Modifiche";
          save.onclick=async()=>{
            const newEx=[];
            d.exercises.forEach((e,ei)=>{
              const series=[];
              e.series.forEach((s,si)=>{
                series.push(document.getElementById(`ex-${ei}-${si}`).value);
              });
              newEx.push({name:e.name,series});
            });
            await setDoc(doc(db,"sessions",docSnap.id),{...d,exercises:newEx});
            alert("Modifiche salvate ‚úÖ"); location.reload();
          };
          div.appendChild(save);
        });
      });
      hist.innerHTML+=`<button id="btnBackHist">‚¨ÖÔ∏è Torna</button>`;
      document.getElementById("btnBackHist").addEventListener("click", backToMenu);
    }

    async function getLastExercise(nome, day) {
      const q=query(collection(db,"sessions"),orderBy("date","desc"));
      const snap=await getDocs(q);
      let prev=null;
      snap.forEach(doc=>{
        const d=doc.data();
        if(d.day===day && !prev) {
          const ex=d.exercises.find(e=>e.name===nome);
          if(ex && ex.series.length>0) prev=ex.series[ex.series.length-1];
        }
      });
      return prev;
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
      document.body.classList.toggle("dark-mode");
    }

    // Bind bottoni menu
    document.getElementById("btnA").addEventListener("click",()=>startSession('A'));
    document.getElementById("btnB").addEventListener("click",()=>startSession('B'));
    document.getElementById("btnDashboard").addEventListener("click",showDashboard);
    document.getElementById("btnHistory").addEventListener("click",showHistory);
    document.getElementById("btnTheme").addEventListener("click",toggleTheme);
  </script>
</body>
</html>
