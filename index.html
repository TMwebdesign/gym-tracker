<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>ğŸ‹ï¸ Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#111; color:#eee; }
    header { background:#222; padding:1rem; text-align:center; font-size:1.3rem; font-weight:bold; }
    button { margin:.3rem; padding:.6rem 1rem; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer; }
    button:hover { background:#218838; }
    .danger { background:#dc3545; }
    .danger:hover { background:#c82333; }
    .secondary { background:#6c757d; }
    .secondary:hover { background:#5a6268; }
    .hidden { display:none; }
    .container { max-width:900px; padding:1rem; margin:auto; }
    .exercise { border:1px solid #444; padding:.7rem; margin-bottom:.7rem; border-radius:6px; }
    .exercise h3 { margin:.2rem 0; }
    .exercise small { color:#aaa; display:block; margin:.3rem 0; }
    input { padding:.3rem; margin:.2rem; width:80px; }
    .series-list { margin:.5rem 0; font-size:.9rem; color:#ccc; }
    .timer { font-weight:bold; color:#0f0; margin-left:.5rem; }
    canvas { background:#fff; border-radius:6px; margin-top:1rem; padding:1rem; }
    .heatmap { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-top:1rem; }
    .heatmap div { width:20px; height:20px; background:#333; }
    .heatmap .active { background:#28a745; }
    .light-mode { background:#fafafa; color:#111; }
    .light-mode header { background:#ddd; color:#000; }
    table { border-collapse: collapse; margin-top:1rem; width:100%; background:#222; }
    th, td { border:1px solid #555; padding:.5rem; text-align:center; }
    th { background:#333; color:#28a745; }
    tr:nth-child(even) { background:#2a2a2a; }
  </style>
</head>
<body>
  <header>ğŸ‹ï¸ Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="startSession('A')">â–¶ Avvia Giorno A</button>
    <button onclick="startSession('B')">â–¶ Avvia Giorno B</button>
    <button onclick="showDashboard()">ğŸ“Š Dashboard</button>
    <button onclick="showHistory()">ğŸ“œ Storico</button>
    <button onclick="toggleTheme()">ğŸŒ™/â˜€ï¸</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ğŸ”‘ CONFIG GITHUB (metti i tuoi dati)
    const GH_USER = "TUO_USERNAME";
    const GH_REPO = "gym-tracker-data";
    const GH_FILE = "sessions.json";
    const GH_TOKEN = "ghp_TUO_TOKEN";

    let timerInterval = null;

    // ğŸ“‹ Schede con muscoli
    const schede = {
      A: [
        { nome:"Chest Press", muscoli:"Petto", come:"Spingi in avanti con gomiti a 90Â°.", att:"Non estendere troppo le braccia." },
        { nome:"Shoulder Press", muscoli:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
        { nome:"Pectoral Machine", muscoli:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
        { nome:"Alzate Laterali", muscoli:"Spalle", come:"Solleva braccia piegate fino alle spalle.", att:"Non oltre i 90Â°." },
        { nome:"Crunch", muscoli:"Addome", come:"Piccolo movimento contrazione addominale.", att:"Non tirare il collo." }
      ],
      B: [
        { nome:"Lat Machine", muscoli:"Dorsali", come:"Tira la barra al petto busto fermo.", att:"Non oscillare." },
        { nome:"Rematore Macchina", muscoli:"Dorsali", come:"Tira manici verso addome.", att:"Non inarcare la schiena." },
        { nome:"Leg Press", muscoli:"Gambe", come:"Spingi con talloni ginocchia a 90Â°.", att:"Non bloccare le gambe." },
        { nome:"Leg Curl", muscoli:"Gambe", come:"Piega gambe contraendo femorali.", att:"Movimento lento." },
        { nome:"Plank", muscoli:"Addome", come:"Corpo in linea addome contratto.", att:"Non inarcare la schiena." }
      ]
    };

    // ğŸ”„ GitHub API
    async function loadSessions() {
      const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FILE}`, {
        headers: { Authorization: `token ${GH_TOKEN}` }
      });
      const data = await res.json();
      const content = atob(data.content);
      return { sessions: JSON.parse(content), sha: data.sha };
    }

    async function saveSessions(sessions, msg="Update session") {
      const { sha } = await loadSessions();
      const content = btoa(JSON.stringify(sessions, null, 2));
      await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FILE}`, {
        method:"PUT",
        headers:{ Authorization:`token ${GH_TOKEN}`, "Content-Type":"application/json" },
        body: JSON.stringify({ message: msg, content, sha })
      });
    }

    function todayKey(day){
      const d=new Date().toISOString().split("T")[0];
      return `${day}-${d}`;
    }

    // ğŸš€ Avvia sessione
    async function startSession(day){
      const { sessions } = await loadSessions();
      const key=todayKey(day);
      let session=sessions.find(s=>s.id===key);
      const prev=sessions.filter(s=>s.day===day).slice(-2, -1)[0]; // penultima sessione

      if(!session){
        session={ id:key, day, date:new Date().toISOString(), exercises:[], muscleStats:{} };
        sessions.push(session);
        await saveSessions(sessions,"Nuova sessione");
      }

      document.getElementById("menu").classList.add("hidden");
      const c=document.getElementById("session");
      c.innerHTML=`<h2>Sessione Giorno ${day}</h2>`;

      schede[day].forEach(ex=>{
        const data=session.exercises.find(e=>e.name===ex.nome);
        const lastSeries = data ? data.series : [];
        const prevSeries = prev ? (prev.exercises.find(e=>e.name===ex.nome)?.series.slice(-1)[0] || "N/A") : "N/A";
        c.innerHTML+=`
          <div class="exercise">
            <h3>${ex.nome}</h3>
            <small>ğŸ’ª Muscoli: ${ex.muscoli}</small>
            <small>ğŸ‘‰ ${ex.come}</small>
            <small>âš ï¸ ${ex.att}</small>
            <small><b>Ultima volta:</b> ${prevSeries}</small><br>
            Rip: <input type="number" class="rip" min="1"> 
            Peso: <input type="number" class="peso" min="0"> 
            <button onclick="addSerie('${key}','${ex.nome}',this)">â• Serie</button>
            <button onclick="startTimer(this,90)">â±ï¸ Recupero</button>
            <button onclick="startAdvancedTimer(this)">â±ï¸ TIMER+</button>
            <span class="timer"></span>
            <div class="series-list">${lastSeries.map(s=>`<div>${s}</div>`).join("")}</div>
          </div>`;
      });

      c.innerHTML+=`<button onclick="backToMenu()">â¬…ï¸ Indietro</button>`;
      c.classList.remove("hidden");
    }
    window.startSession=startSession;

    async function addSerie(key,name,btn){
      const parent=btn.parentElement;
      const rip=parent.querySelector(".rip").value;
      const peso=parent.querySelector(".peso").value;
      if(!rip||!peso) return alert("Inserisci ripetizioni e peso");
      const serie=`${rip}x${peso}kg`;
      const { sessions } = await loadSessions();
      const s=sessions.find(x=>x.id===key);
      let ex=s.exercises.find(e=>e.name===name);
      if(!ex){ ex={name,series:[]}; s.exercises.push(ex); }
      ex.series.push(serie);
      await saveSessions(sessions,"Aggiornata sessione");
      parent.querySelector(".series-list").innerHTML+=`<div>${serie}</div>`;
      parent.querySelector(".rip").value="";
      parent.querySelector(".peso").value="";
    }
    window.addSerie=addSerie;

    function startTimer(btn,seconds){
      const timerEl=btn.nextElementSibling;
      let t=seconds;
      clearInterval(timerInterval);
      timerInterval=setInterval(()=>{
        timerEl.textContent=`${t}s`;
        if(t<=5&&t>0) document.getElementById("beep").play();
        if(t<=0) clearInterval(timerInterval);
        t--;
      },1000);
    }
    window.startTimer=startTimer;

    async function startAdvancedTimer(btn){
      const parent=btn.parentElement;
      const num=parseInt(prompt("Quante serie?",4));
      const exec=parseInt(prompt("Tempo esecuzione (s)?",30));
      const rec=parseInt(prompt("Recupero (s)?",60));
      if(!num||!exec||!rec) return;
      const timerEl=parent.querySelector(".timer");
      clearInterval(timerInterval);
      let serie=1, phase="prep", t=5;
      timerInterval=setInterval(()=>{
        if(t>0){
          timerEl.textContent= phase==="prep"?`âŒ› Prep: ${t}s`:
            phase==="exec"?`ğŸ”µ Serie ${serie}/${num}: ${t}s`:`ğŸŸ¢ Rec: ${t}s`;
          if(t<=5) document.getElementById("beep").play();
          t--;
        } else {
          if(phase==="prep"){phase="exec";t=exec;}
          else if(phase==="exec"){ if(serie<num){phase="rec";t=rec;} else {timerEl.textContent="âœ… Fine";clearInterval(timerInterval);} }
          else if(phase==="rec"){serie++;phase="exec";t=exec;}
        }
      },1000);
    }
    window.startAdvancedTimer=startAdvancedTimer;

    function backToMenu(){["session","dashboard","history"].forEach(id=>document.getElementById(id).classList.add("hidden"));document.getElementById("menu").classList.remove("hidden");}
    window.backToMenu=backToMenu;

    // ğŸ“Š Dashboard
    async function showDashboard(){
      document.getElementById("menu").classList.add("hidden");
      const dash=document.getElementById("dashboard");
      dash.classList.remove("hidden");
      dash.innerHTML=`<h2>ğŸ“Š Dashboard</h2>
        <canvas id="chart"></canvas>
        <canvas id="pie"></canvas>
        <h3>ğŸ† PR per esercizio</h3><div id="prTable"></div>
        <button onclick="backToMenu()">â¬…ï¸ Indietro</button>`;
      const { sessions }=await loadSessions();
      drawChart(sessions);
      drawPie(sessions);
      drawPR(sessions);
    }
    window.showDashboard=showDashboard;

    function drawChart(sessions){
      const ctx=document.getElementById("chart").getContext("2d");
      const labels=sessions.map(s=>new Date(s.date).toLocaleDateString());
      const values=sessions.map(s=>s.exercises.reduce((tot,e)=>tot+e.series.length,0));
      new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Serie totali",data:values,borderColor:"#28a745"}]},options:{plugins:{legend:{labels:{color:"white"}}},scales:{x:{ticks:{color:"white"}},y:{ticks:{color:"white"}}}}});
    }

    function drawPie(sessions){
      const counts={};
      sessions.forEach(s=>s.exercises.forEach(e=>{
        const m=schede[s.day].find(x=>x.nome===e.name)?.muscoli;
        if(m) counts[m]=(counts[m]||0)+e.series.length;
      }));
      const ctx=document.getElementById("pie").getContext("2d");
      new Chart(ctx,{type:"pie",data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts),backgroundColor:["#28a745","#007bff","#ffc107","#dc3545","#17a2b8"]}]},options:{plugins:{legend:{labels:{color:"white"}}}}});
    }

    function drawPR(sessions){
      const pr={};
      sessions.forEach(s=>s.exercises.forEach(ex=>ex.series.forEach(str=>{
        const m=str.match(/(\d+)x(\d+)/);if(m){const rip=+m[1],peso=+m[2];if(!pr[ex.name]||peso>pr[ex.name].peso){const oneRM=Math.round(peso*(1+rip/30));pr[ex.name]={peso,rip,oneRM};}}}));
      const c=document.getElementById("prTable");c.innerHTML="<table><tr><th>Esercizio</th><th>Peso max</th><th>Rip</th><th>1RM stimato</th></tr>";
      for(const [n,v] of Object.entries(pr)){c.innerHTML+=`<tr><td>${n}</td><td>${v.peso}kg</td><td>${v.rip}</td><td>${v.oneRM}kg</td></tr>`;}
      c.innerHTML+="</table>";
    }

    // ğŸ“œ Storico
    async function showHistory(){
      document.getElementById("menu").classList.add("hidden");
      const hist=document.getElementById("history");hist.classList.remove("hidden");
      hist.innerHTML="<h2>ğŸ“œ Storico</h2><div id='historyList'></div><button onclick='backToMenu()'>â¬…ï¸ Indietro</button>";
      const { sessions }=await loadSessions();
      const list=document.getElementById("historyList");
      sessions.slice().reverse().forEach((s,idx)=>{
        const div=document.createElement("div");
        div.style="border:1px solid #444;margin:.5rem 0;padding:.5rem;border-radius:6px;";
        const musc={};s.exercises.forEach(e=>{
          const m=schede[s.day].find(x=>x.nome===e.name)?.muscoli;
          if(m) musc[m]=(musc[m]||0)+e.series.length;
        });
        div.innerHTML=`<b>${s.day}</b> - ${new Date(s.date).toLocaleDateString()} 
          <button class="danger" onclick="deleteSession('${s.id}')">ğŸ—‘ï¸</button><br>
          ${s.exercises.map(e=>`${e.name}: ${e.series.join(", ")}`).join("<br>")}
          <br><i>Distribuzione: ${Object.entries(musc).map(([k,v])=>`${k} ${v}`).join(", ")}</i>`;
        list.appendChild(div);
      });
    }
    window.showHistory=showHistory;

    async function deleteSession(id){const { sessions }=await loadSessions();const i=sessions.findIndex(s=>s.id===id);if(i>-1){sessions.splice(i,1);await saveSessions(sessions,"Eliminata sessione");showHistory();}}
    window.deleteSession=deleteSession;

    function toggleTheme(){document.body.classList.toggle("light-mode");}
    window.toggleTheme=toggleTheme;
  </script>
</body>
</html>
