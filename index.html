<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family:'Segoe UI',sans-serif;background:#fff;color:#000;margin:0;padding:0;}
    header{background:#007bff;color:#fff;padding:1rem;text-align:center;font-size:1.3rem;}
    .container{max-width:850px;margin:auto;padding:1rem;}
    button{margin:.4rem;padding:.6rem 1.2rem;border:none;border-radius:6px;cursor:pointer;color:#fff;background:#007bff;font-weight:bold;}
    button:hover{background:#0056b3;}
    input{padding:.3rem;margin:.3rem;width:80px;}
    textarea{width:100%;min-height:60px;margin-top:.5rem;padding:.4rem;border-radius:6px;border:1px solid #ccc;}
    .hidden{display:none;}
    .exercise{border:1px solid #ddd;padding:.8rem;margin-bottom:.8rem;border-radius:8px;background:#f9f9f9;}
    .exercise h3{margin:.2rem 0;}
    .series-list div{padding:.2rem 0;}
    .delete-serie{cursor:pointer;color:red;margin-left:.5rem;}
    .timer-sticky{position:fixed;bottom:50%;left:10px;background:#222;color:#fff;padding:.5rem 1rem;border-radius:8px;display:none;font-weight:bold;}
  </style>
</head>
<body>
<header>üèãÔ∏è Gym Tracker PRO</header>

<div class="container" id="menu">
  <button onclick="startSession('A')">‚ñ∂ Giorno A</button>
  <button onclick="startSession('B')">‚ñ∂ Giorno B</button>
  <button onclick="showDashboard()">üìä Dashboard</button>
  <button onclick="showHistory()">üìú Storico</button>
</div>

<div class="container hidden" id="session"></div>
<div class="container hidden" id="dashboard"></div>
<div class="container hidden" id="history"></div>
<div id="stickyTimer" class="timer-sticky"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supa = createClient(
  "https://oyzouvusoysuhylijfdm.supabase.co",
  "sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm"
);

const schede = {
  A:[
    {nome:"Chest Press",muscolo:"Petto"},
    {nome:"Shoulder Press",muscolo:"Spalle"},
    {nome:"Pectoral Machine",muscolo:"Petto"},
    {nome:"Alzate Laterali",muscolo:"Spalle"},
    {nome:"Crunch",muscolo:"Addome"}
  ],
  B:[
    {nome:"Lat Machine",muscolo:"Dorso"},
    {nome:"Rematore",muscolo:"Dorso"},
    {nome:"Leg Press",muscolo:"Gambe"},
    {nome:"Leg Curl",muscolo:"Femorali"},
    {nome:"Plank",muscolo:"Core"}
  ]
};

let currentSession=null,timer=null;

/* ==========================
   üöÄ AVVIO SESSIONE
   ========================== */
async function startSession(day){
  const today=new Date().toISOString().split("T")[0];
  let {data}=await supa.from("sessions").select("*").eq("day",day).eq("date",today).single();

  if(!data){
    const {data:newData}=await supa.from("sessions").insert([{day,date:today}]).select().single();
    data=newData;
  }
  currentSession=data;
  renderSession(day,data.id);
}
window.startSession=startSession;

async function renderSession(day,sessionId){
  document.getElementById("menu").classList.add("hidden");
  const c=document.getElementById("session");
  c.classList.remove("hidden");
  c.innerHTML=`<h2>Sessione Giorno ${day}</h2>`;

  for(const ex of schede[day]){
    const {data:last}=await supa.from("exercises").select("*").eq("name",ex.nome).order("id",{ascending:false}).limit(1);
    const prev=last&&last.length>0?last[0].series.map(s=>`${s.rip}x${s.peso}kg`).join(", "):"N/A";

    c.innerHTML+=`
      <div class="exercise" data-name="${ex.nome}" data-muscolo="${ex.muscolo}">
        <h3>${ex.nome}</h3><small>${ex.muscolo}</small>
        <div>Ultima volta: ${prev}</div>
        Rip: <input type="number" class="rip"> Peso: <input type="number" class="peso">
        <button onclick="addSerie(this)">‚ûï Serie</button>
        <button onclick="startTimer(60)">‚è±Ô∏è Recupero</button>
        <div class="series-list"></div>
      </div>`;
  }

  c.innerHTML+=`<textarea id="note" placeholder="Note...">${currentSession.notes||""}</textarea>
  <button onclick="saveSession()">üíæ Salva Sessione</button>
  <button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>`;
}

/* ==========================
   ‚ûï AGGIUNTA SERIE
   ========================== */
window.addSerie=(btn)=>{
  const ex=btn.closest(".exercise");
  const rip=ex.querySelector(".rip").value;
  const peso=ex.querySelector(".peso").value;
  if(!rip||!peso)return alert("Inserisci ripetizioni e peso");
  ex.querySelector(".series-list").innerHTML+=
    `<div>${rip}x${peso}kg <span class='delete-serie' onclick='this.parentElement.remove()'>üóë</span></div>`;
};

/* ==========================
   üíæ SALVATAGGIO SESSIONE
   ========================== */
async function saveSession(){
  const exs=Array.from(document.querySelectorAll(".exercise")).map(e=>{
    const name=e.dataset.name,muscolo=e.dataset.muscolo;
    const series=Array.from(e.querySelectorAll(".series-list div")).map(s=>{
      const m=s.innerText.match(/(\d+)x(\d+)/);return m?{rip:+m[1],peso:+m[2]}:null;
    }).filter(Boolean);
    return {name,muscolo,series};
  }).filter(e=>e.series.length>0);

  // salva in exercises
  for(const ex of exs){
    const vol=ex.series.reduce((a,b)=>a+b.rip*b.peso,0);
    await supa.from("exercises").insert([{session_id:currentSession.id,name:ex.name,muscolo:ex.muscolo,series:ex.series,volume:vol}]);
  }

  const totalSeries=exs.reduce((a,b)=>a+b.series.length,0);
  const totalVolume=exs.reduce((a,b)=>a+b.series.reduce((x,y)=>x+y.rip*y.peso,0),0);
  const note=document.getElementById("note").value;

  await supa.from("sessions").update({
    exercises:exs,
    notes:note,
    total_series:totalSeries,
    total_volume:totalVolume
  }).eq("id",currentSession.id);

  alert("Sessione salvata ‚úÖ");
  backToMenu();
}
window.saveSession=saveSession;

/* ==========================
   üìä DASHBOARD
   ========================== */
async function showDashboard(){
  document.getElementById("menu").classList.add("hidden");
  const dash=document.getElementById("dashboard");
  dash.classList.remove("hidden");
  dash.innerHTML=`<h2>üìä Dashboard</h2><canvas id='chart1' height='200'></canvas><canvas id='chart2' height='200' style='margin-top:1rem'></canvas><button onclick='backToMenu()'>‚¨ÖÔ∏è Torna</button>`;

  const {data}=await supa.from("sessions").select("*").order("date",{ascending:true});
  if(!data||data.length===0){dash.innerHTML+="<p>Nessuna sessione.</p>";return;}

  const ctx=document.getElementById("chart1").getContext("2d");
  new Chart(ctx,{type:"line",data:{labels:data.map(d=>d.date),datasets:[{label:"Serie totali",data:data.map(d=>d.total_series),borderColor:"#007bff"}]}});

  const muscoli={};
  data.forEach(d=>d.exercises?.forEach(e=>{
    muscoli[e.muscolo]=(muscoli[e.muscolo]||0)+e.series.length;
  }));
  const ctx2=document.getElementById("chart2").getContext("2d");
  new Chart(ctx2,{type:"pie",data:{labels:Object.keys(muscoli),datasets:[{data:Object.values(muscoli),backgroundColor:["#f94144","#f9c74f","#90be6d","#577590","#43aa8b"]}]}});
}
window.showDashboard=showDashboard;

/* ==========================
   üìú STORICO
   ========================== */
async function showHistory(){
  document.getElementById("menu").classList.add("hidden");
  const h=document.getElementById("history");
  h.classList.remove("hidden");
  const {data}=await supa.from("sessions").select("*").order("date",{ascending:false});
  h.innerHTML="<h2>üìú Storico</h2>";
  data.forEach(d=>{
    const div=document.createElement("div");
    div.classList.add("exercise");
    div.innerHTML=`<b>${d.day}</b> - ${d.date}<br>${d.exercises?d.exercises.map(e=>`${e.name}: ${e.series.map(s=>`${s.rip}x${s.peso}kg`).join(", ")}`).join("<br>"):"N/A"}<br><b>Note:</b> ${d.notes||"-"}<br><button onclick='deleteSession(${d.id})'>üóë Elimina</button>`;
    h.appendChild(div);
  });
  h.innerHTML+="<button onclick='backToMenu()'>‚¨ÖÔ∏è Torna</button>";
}
window.deleteSession=async(id)=>{if(confirm("Eliminare?")){await supa.from("sessions").delete().eq("id",id);showHistory();}};

/* ==========================
   ‚è±Ô∏è TIMER STICKY
   ========================== */
function startTimer(sec){
  const t=document.getElementById("stickyTimer");
  let s=sec;clearInterval(timer);t.style.display="block";
  timer=setInterval(()=>{
    t.textContent=`‚è± ${s}s`;s--;
    if(s<0){clearInterval(timer);t.textContent="‚úÖ";setTimeout(()=>t.style.display="none",1500);}
  },1000);
}
window.startTimer=startTimer;

/* ==========================
   ‚¨ÖÔ∏è BACK TO MENU
   ========================== */
function backToMenu(){
  ["session","dashboard","history"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById("menu").classList.remove("hidden");
}
window.backToMenu=backToMenu;
</script>
</body>
</html>
