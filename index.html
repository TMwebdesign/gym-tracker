<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>üèãÔ∏è Gym Tracker PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ======== üåû TEMA CHIARO / UI MODERNA ======== */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #111;
    }
    header {
      text-align: center;
      padding: 1.2rem;
      background: #ffffff;
      color: #111;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: .7rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
      margin: .3rem;
    }
    button:hover { background: #0056b3; }

    .exercise {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .exercise h3 {
      margin: 0 0 .3rem 0;
      color: #007bff;
    }
    .exercise small {
      color: #666;
      display: block;
      margin: .3rem 0;
    }
    input {
      padding: .4rem;
      margin: .2rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 70px;
    }
    .series-list {
      margin-top: .4rem;
      font-size: .9rem;
      color: #333;
    }
    .series-list div {
      background: #eef3ff;
      padding: .3rem .5rem;
      margin: .2rem 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-serie {
      cursor: pointer;
      color: #d33;
      font-weight: bold;
    }
    .hidden { display: none; }

    /* ===== TIMER sticky ===== */
    #sticky-timer {
      position: fixed;
      bottom: 40%;
      left: 20px;
      background: #007bff;
      color: white;
      padding: .7rem 1.2rem;
      border-radius: 50px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-weight: bold;
      z-index: 1000;
      display: none;
    }

    /* ===== Grafici e Dashboard ===== */
    canvas {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: .7rem;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }

    /* ===== Loader ===== */
    #loader {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:white;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:1.3rem;
      color:#007bff;
      z-index:2000;
    }

    /* ===== Note e Riepilogo ===== */
    textarea {
      width:100%;
      min-height:80px;
      border-radius:8px;
      border:1px solid #ccc;
      padding:.7rem;
      resize:none;
      margin-top:.5rem;
    }
    .summary {
      background:#fff;
      border-radius:8px;
      padding:1rem;
      margin-top:1rem;
      box-shadow:0 1px 6px rgba(0,0,0,0.1);
    }
    .motivational {
      text-align:center;
      font-weight:bold;
      margin:1rem 0;
      color:#28a745;
    }
  </style>
</head>
<body>
  <div id="loader">üèãÔ∏è‚Äç‚ôÇÔ∏è Prepariamo la tua scheda...</div>
  <header>üèãÔ∏è Gym Tracker PRO</header>

  <div class="container" id="menu">
    <button onclick="startSession('A')">‚ñ∂ Giorno A</button>
    <button onclick="startSession('B')">‚ñ∂ Giorno B</button>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showHistory()">üìú Storico</button>
  </div>

  <div class="container hidden" id="session"></div>
  <div class="container hidden" id="dashboard"></div>
  <div class="container hidden" id="history"></div>

  <div id="sticky-timer">‚è±Ô∏è 00s</div>
<script type="module">
/* =======================
   üîó CONNESSIONE SUPABASE
   ======================= */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://oyzouvusoysuhylijfdm.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_xsQgX8-AhpHzK0Cn4rfW9A_rzF6fVEm"; 
const supa = createClient(SUPABASE_URL, SUPABASE_KEY);

/* =======================
   ‚öôÔ∏è VARIABILI GLOBALI
   ======================= */
let currentSession = null;
let timerInterval = null;
let stickyTimer = document.getElementById("sticky-timer");
let timerRunning = false;

/* =======================
   üèãÔ∏è SCHEDE ESERCIZI BASE
   ======================= */
const schede = {
  A: [
    { nome:"Chest Press", muscolo:"Petto", come:"Spingi in avanti mantenendo i gomiti a 90¬∞.", att:"Non estendere troppo le braccia." },
    { nome:"Shoulder Press", muscolo:"Spalle", come:"Spingi sopra la testa con schiena aderente.", att:"Non inarcare la schiena." },
    { nome:"Pectoral Machine", muscolo:"Petto", come:"Chiudi le braccia come un abbraccio.", att:"Non sbattere le braccia al centro." },
    { nome:"Alzate Laterali", muscolo:"Spalle", come:"Braccia piegate, solleva fino alle spalle.", att:"Non oltre i 90¬∞." },
    { nome:"Crunch", muscolo:"Addome", come:"Contrai l‚Äôaddome.", att:"Non tirare il collo." }
  ],
  B: [
    { nome:"Lat Machine", muscolo:"Dorso", come:"Tira la barra al petto mantenendo il busto fermo.", att:"Non oscillare con la schiena." },
    { nome:"Rematore", muscolo:"Dorso", come:"Tira i manici verso l‚Äôaddome.", att:"Non inarcare la schiena." },
    { nome:"Leg Press", muscolo:"Gambe", come:"Spingi con i talloni, ginocchia a 90¬∞.", att:"Non stendere del tutto le gambe." },
    { nome:"Leg Curl", muscolo:"Femorali", come:"Piega le gambe contraendo i femorali.", att:"Movimento lento e controllato." },
    { nome:"Plank", muscolo:"Core", come:"Corpo in linea, addome contratto.", att:"Non inarcare la schiena." }
  ]
};

/* =======================
   üöÄ AVVIO SESSIONE
   ======================= */
async function startSession(day) {
  document.getElementById("loader").style.display = "flex";
  const today = new Date().toISOString().split("T")[0];
  let { data } = await supa.from("sessions").select("*").eq("day", day).eq("date", today).maybeSingle();

  if (!data) {
    const { data: newSession } = await supa.from("sessions").insert([{ day, date: today, notes:"", total_volume:0 }]).select().single();
    currentSession = newSession;
  } else currentSession = data;

  renderSession(day);
  document.getElementById("loader").style.display = "none";
}
window.startSession = startSession;

/* =======================
   üñºÔ∏è RENDER SESSIONE
   ======================= */
async function renderSession(day) {
  document.getElementById("menu").classList.add("hidden");
  const c = document.getElementById("session");
  c.classList.remove("hidden");

  c.innerHTML = `<h2>Sessione Giorno ${day}</h2>`;

  for (const ex of schede[day]) {
    const last = await getLastExercise(ex.nome);
    c.innerHTML += `
      <div class="exercise" data-name="${ex.nome}">
        <h3>${ex.nome}</h3>
        <small>(${ex.muscolo})</small>
        <small>üëâ ${ex.come}</small>
        <small>‚ö†Ô∏è ${ex.att}</small>
        <small><b>Ultima volta:</b> ${last || "N/A"}</small><br>
        Rip: <input type="number" class="rip" min="1"> 
        Peso: <input type="number" class="peso" min="0"> 
        <button onclick="addSerie(this)">‚ûï Serie</button>
        <button onclick="startTimer(this,60)">‚è±Ô∏è Recupero</button>
        <button onclick="startDynamicTimer(this,30,60,4)">‚è±Ô∏è+ Dinamico</button>
        <div class="series-list"></div>
      </div>`;
  }

  c.innerHTML += `
    <textarea id="note" placeholder="Aggiungi note finali..."></textarea>
    <button onclick="saveSession()">üíæ Salva sessione</button>
    <button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>
  `;
}

/* =======================
   ‚ûï AGGIUNTA SERIE
   ======================= */
function addSerie(btn) {
  const ex = btn.closest(".exercise");
  const rip = ex.querySelector(".rip").value;
  const peso = ex.querySelector(".peso").value;
  if (!rip || !peso) return alert("Inserisci ripetizioni e peso!");
  const list = ex.querySelector(".series-list");
  const serieEl = document.createElement("div");
  serieEl.innerHTML = `${rip} x ${peso}kg <span class="delete-serie" onclick="deleteSerie(this)">üóë</span>`;
  list.appendChild(serieEl);
  ex.querySelector(".rip").value = "";
  ex.querySelector(".peso").value = "";
}
window.addSerie = addSerie;

function deleteSerie(el) { el.parentElement.remove(); }
window.deleteSerie = deleteSerie;

/* =======================
   ‚è±Ô∏è TIMER BASE
   ======================= */
function startTimer(btn, sec) {
  let time = sec;
  stickyTimer.style.display = "block";
  timerRunning = true;
  stickyTimer.textContent = `‚è±Ô∏è ${time}s`;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    stickyTimer.textContent = `‚è±Ô∏è ${time}s`;
    time--;
    if (time < 0) {
      clearInterval(timerInterval);
      stickyTimer.textContent = "‚úÖ Fine";
      timerRunning = false;
      setTimeout(() => stickyTimer.style.display = "none", 1500);
    }
  }, 1000);
}
window.startTimer = startTimer;

/* =======================
   ‚è±Ô∏è TIMER DINAMICO (SERIE+RECUPERO)
   ======================= */
function startDynamicTimer(btn, esecSec, recSec, serieTotali) {
  let serie = 1;
  function nextSerie() {
    if (serie > serieTotali) {
      stickyTimer.textContent = "üèÅ Completato!";
      setTimeout(()=>stickyTimer.style.display="none",2000);
      return;
    }
    stickyTimer.style.display = "block";
    let t = esecSec;
    stickyTimer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
    const faseEsec = setInterval(()=>{
      stickyTimer.textContent = `Serie ${serie}/${serieTotali} ‚ñ∂ ${t}s`;
      t--;
      if(t<0){
        clearInterval(faseEsec);
        let r = recSec;
        const faseRec = setInterval(()=>{
          stickyTimer.textContent = `Recupero ${r}s`;
          r--;
          if(r<0){
            clearInterval(faseRec);
            serie++;
            nextSerie();
          }
        },1000);
      }
    },1000);
  }
  nextSerie();
}
window.startDynamicTimer = startDynamicTimer;
/* =======================
   üíæ SALVATAGGIO SESSIONE (FIXED)
   ======================= */
async function saveSession() {
  const list = document.querySelectorAll(".exercise");
  let exData = [];
  let totalVol = 0;

  list.forEach(ex=>{
    const name = ex.dataset.name;
    const muscolo = ex.querySelector("small").innerText.replace(/[()]/g,"");
    const series = Array.from(ex.querySelectorAll(".series-list div")).map(s=>{
      const match = s.innerText.match(/(\d+)\s*x\s*(\d+)/);
      if(match){
        const rip = +match[1];
        const peso = +match[2];
        totalVol += rip*peso;
        return {rip,peso};
      }
      return null;
    }).filter(Boolean);
    if(series.length>0) exData.push({ name, muscolo, series });
  });

  const notes = document.getElementById("note").value;

  // üîπ 1. Aggiorna i dati della sessione
  const { error: sessionErr } = await supa
    .from("sessions")
    .update({
      notes,
      total_volume: totalVol,
      total_series: exData.reduce((a,b)=>a+b.series.length,0)
    })
    .eq("id", currentSession.id);

  if (sessionErr) {
    console.error("Errore salvataggio sessione:", sessionErr);
    alert("‚ùå Errore nel salvataggio della sessione!");
    return;
  }

  // üîπ 2. Elimina eventuali esercizi precedenti di quella sessione
  await supa.from("exercises").delete().eq("session_id", currentSession.id);

  // üîπ 3. Inserisci i nuovi esercizi
  const insertPromises = exData.map(ex => 
    supa.from("exercises").insert({
      session_id: currentSession.id,
      name: ex.name,
      muscolo: ex.muscolo,
      series: ex.series,
      volume: ex.series.reduce((a,b)=>a+b.rip*b.peso,0)
    })
  );
  await Promise.all(insertPromises);

  alert("‚úÖ Sessione salvata con successo!");
  backToMenu();
}
window.saveSession = saveSession;


/* =======================
   ‚èÆÔ∏è BACK
   ======================= */
function backToMenu() {
  document.getElementById("session").classList.add("hidden");
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("history").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}
window.backToMenu = backToMenu;

/* =======================
   üìå ULTIMO ALLENAMENTO
   ======================= */
async function getLastExercise(nome) {
  const { data, error } = await supa
    .from("exercises")
    .select("series, created_at")
    .eq("name", nome)
    .order("created_at", { ascending: false })
    .limit(1);

  if (error || !data || data.length === 0) return null;
  const ex = data[0];
  return ex.series.map(s => `${s.rip}x${s.peso}kg`).join(", ");
}
window.getLastExercise = getLastExercise;


/* =======================
   ‚ö° LOADER HIDE
   ======================= */
window.addEventListener("load", ()=>{ document.getElementById("loader").style.display="none"; });
</script>
<script type="module">
import "https://cdn.jsdelivr.net/npm/chart.js";

async function showDashboard() {
  document.getElementById("menu").classList.add("hidden");
  const dash = document.getElementById("dashboard");
  dash.classList.remove("hidden");
  dash.innerHTML = `
    <h2>üìä Dashboard</h2>
    <canvas id="chartSeries" height="200"></canvas>
    <canvas id="chartMuscoli" height="200" style="margin-top:1rem"></canvas>
    <div class="summary" id="summary"></div>
    <button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>
  `;

  const { data: sessions } = await supa
    .from("sessions")
    .select("*")
    .order("date", { ascending: true });

  const { data: exercises } = await supa
    .from("exercises")
    .select("session_id, muscolo, volume");

  if (!sessions || sessions.length === 0) {
    dash.innerHTML += "<p>Nessuna sessione registrata.</p>";
    return;
  }

  // Serie per sessione
  const labels = sessions.map(d => d.date);
  const seriesCounts = sessions.map(d => d.total_series || 0);

  new Chart(document.getElementById("chartSeries"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Serie totali per sessione",
        data: seriesCounts,
        borderColor: "#007bff",
        fill: false,
        tension: .3
      }]
    },
    options: { plugins: { legend: { display: false } } }
  });

  // Raggruppamento per muscolo
  const muscoliMap = {};
  exercises.forEach(e => {
    muscoliMap[e.muscolo] = (muscoliMap[e.muscolo] || 0) + 1;
  });

  const ctx2 = document.getElementById("chartMuscoli");
  new Chart(ctx2, {
    type: "pie",
    data: {
      labels: Object.keys(muscoliMap),
      datasets: [{
        data: Object.values(muscoliMap),
        backgroundColor: ["#f94144","#f9c74f","#90be6d","#577590","#43aa8b","#ff6f00"]
      }]
    }
  });

  const totalVol = sessions.reduce((a,b)=>a+(b.total_volume||0),0);
  document.getElementById("summary").innerHTML = `
    <h3>Totale Volume: ${totalVol} kg</h3>
    <p>Media serie per sessione: ${(seriesCounts.reduce((a,b)=>a+b,0)/seriesCounts.length).toFixed(1)}</p>
  `;
}
window.showDashboard = showDashboard;


/* =======================
   üìú STORICO COMPLETO
   ======================= */
async function showHistory() {
  document.getElementById("menu").classList.add("hidden");
  const hist = document.getElementById("history");
  hist.classList.remove("hidden");
  hist.innerHTML = `<h2>üìú Storico</h2>`;

  const { data: sessions } = await supa.from("sessions").select("*").order("date",{ascending:false});
  const { data: exercises } = await supa.from("exercises").select("*");

  if (!sessions || sessions.length === 0) {
    hist.innerHTML += "<p>Nessuna sessione salvata.</p><button onclick='backToMenu()'>‚¨ÖÔ∏è Torna</button>";
    return;
  }

  sessions.forEach(s => {
    const exs = exercises.filter(e => e.session_id === s.id);
    const div = document.createElement("div");
    div.classList.add("exercise");
    div.innerHTML = `
      <b>${s.day}</b> - ${s.date}<br>
      ${exs.length > 0 
        ? exs.map(e => `<u>${e.name}</u>: ${e.series.map(s=>`${s.rip}x${s.peso}kg`).join(", ")}`).join("<br>")
        : "<i>Nessun esercizio</i>"
      }
      <p><b>Note:</b> ${s.notes || "-"}</p>
      <button onclick="editSession(${s.id})">‚úèÔ∏è Modifica</button>
      <button onclick="deleteSession(${s.id})">üóë Elimina</button>
      <hr>
    `;
    hist.appendChild(div);
  });

  hist.innerHTML += `<button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>`;
}
window.showHistory = showHistory;

/* =======================
   ‚úèÔ∏è MODIFICA / üóë ELIMINA
   ======================= */
async function deleteSession(id){
  if(!confirm("Eliminare questa sessione?")) return;
  await supa.from("sessions").delete().eq("id",id);
  alert("Sessione eliminata");
  showHistory();
}
window.deleteSession = deleteSession;

async function editSession(id){
  const { data } = await supa.from("sessions").select("*").eq("id",id).single();
  if(!data) return alert("Errore");
  currentSession=data;
  renderEditSession(data);
}
window.editSession = editSession;

async function renderEditSession(session) {
  document.getElementById("history").classList.add("hidden");
  const c = document.getElementById("session");
  c.classList.remove("hidden");
  c.innerHTML = `<h2>Modifica ${session.day} - ${session.date}</h2>`;

  const { data: exercises } = await supa.from("exercises").select("*").eq("session_id", session.id);

  if (exercises && exercises.length > 0) {
    exercises.forEach(ex => {
      const div = document.createElement("div");
      div.classList.add("exercise");
      div.innerHTML = `
        <h3>${ex.name}</h3>
        <div class="series-list">
          ${ex.series.map(s => `<div>${s.rip}x${s.peso}kg <span class='delete-serie' onclick='deleteSerie(this)'>üóë</span></div>`).join("")}
        </div>
      `;
      c.appendChild(div);
    });
  }

  c.innerHTML += `
    <textarea id="note" placeholder="Note...">${session.notes || ""}</textarea>
    <button onclick="saveSession()">üíæ Salva</button>
    <button onclick="backToMenu()">‚¨ÖÔ∏è Torna</button>
  `;
}
window.renderEditSession = renderEditSession;

</script>
</body>
</html>


